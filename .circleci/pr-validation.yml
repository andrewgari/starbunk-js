version: 2.1

executors:
  node20:
    docker:
      - image: cimg/node:20.16
    resource_class: medium
  docker:
    machine: true
    resource_class: medium

commands:
  setup_npm_cache:
    steps:
      - restore_cache:
          keys:
            - v1-npm-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-{{ arch }}-{{ .Branch }}-
            - v1-npm-{{ arch }}-
      - run:
          name: Install dependencies
          command: npm ci
      - save_cache:
          key: v1-npm-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules
  persist_build_artifacts:
    steps:
      - run:
          name: Compress build artifacts
          command: |
            tar -czf build-artifacts.tar.gz \
              src/*/dist/ \
              src/*/package.json \
              src/shared/node_modules/ \
              package.json \
              package-lock.json
      - persist_to_workspace:
          root: .
          paths:
            - build-artifacts.tar.gz
  attach_build_artifacts:
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Extract build artifacts
          command: tar -xzf build-artifacts.tar.gz

# ============================================================================
# PHASE 1: CODE QUALITY GATES
# ============================================================================
jobs:
  detect_changes:
    executor: node20
    steps:
      - checkout
      - run:
          name: Fetch main for diff
          command: git fetch origin main || true
      - run:
          name: Detect changed paths
          command: .circleci/scripts/detect_changes.sh
      - persist_to_workspace:
          root: .
          paths:
            - .circleci/diff.json
            - .circleci/changed_files.txt

  lint_and_format:
    executor: node20
    steps:
      - checkout
      - setup_npm_cache
      - run:
          name: Lint and Format Check
          command: |
            npm run lint -- --cache --cache-location .eslintcache
            npm run format -- --check

  type_check:
    executor: node20
    steps:
      - checkout
      - setup_npm_cache
      - run:
          name: TypeScript Type Check
          command: npm run type-check

  build_apps:
    executor: node20
    steps:
      - checkout
      - setup_npm_cache
      - run:
          name: Build All Apps
          command: |
            npm run clean || true
            npm run build
      - persist_build_artifacts

  unit_tests:
    executor: node20
    steps:
      - checkout
      - setup_npm_cache
      - run:
          name: Unit Tests (All Packages)
          command: npm run test

  snyk_code_scan:
    executor: node20
    steps:
      - checkout
      - setup_npm_cache
      - run:
          name: "Snyk Code Scan"
          command: |
            if [ -z "$SNYK_TOKEN" ]; then
              echo "SNYK_TOKEN not set, skipping code scan"; exit 0; fi
            npm install -g snyk@latest
            snyk auth $SNYK_TOKEN
            snyk code test --severity-threshold=high || snyk code test --severity-threshold=critical

# ============================================================================
# PHASE 2 & 3: CONDITIONAL DOCKER BUILD + HEALTH CHECK
# ============================================================================
  docker_bunkbot:
    executor: docker
    steps:
      - checkout
      - attach_build_artifacts
      - setup_remote_docker
      - run:
          name: "[Phase 2] Build Docker Image"
          command: |
            set -e
            APP="bunkbot"
            DOCKERFILE="./src/bunkbot/Dockerfile.ci"
            
            # Compute content hash for caching
            HASH=$(git rev-parse HEAD:src/${APP} 2>/dev/null || echo "no-hash")
            SHARED_HASH=$(git rev-parse HEAD:src/shared 2>/dev/null || echo "no-shared")
            DEPS_HASH=$(sha256sum package-lock.json | cut -d' ' -f1 | head -c 12)
            CONTENT_HASH="${HASH:0:12}-${SHARED_HASH:0:12}-${DEPS_HASH}"
            
            # Login to GHCR
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
            
            # Try to pull from cache (sha-based tag)
            IMAGE_BASE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}"
            IMAGE_CACHE="${IMAGE_BASE}:sha-${CONTENT_HASH}"
            IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_PULL_REQUEST##*/}"
            [ -z "$IMAGE_CURRENT" ] && IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_BUILD_NUM}"
            
            if docker pull "${IMAGE_CACHE}" 2>/dev/null; then
              echo "Using cached image: ${IMAGE_CACHE}"
              docker tag "${IMAGE_CACHE}" "${IMAGE_CURRENT}"
            else
              echo "Building fresh image (cache miss)"
              docker build -f "${DOCKERFILE}" \
                -t "${IMAGE_CURRENT}" \
                -t "${IMAGE_CACHE}" .
              docker push "${IMAGE_CACHE}"
            fi
            
            docker push "${IMAGE_CURRENT}"
      - run:
          name: "[Phase 3] Health Check"
          command: |
            set -e
            APP="bunkbot"
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            IMAGE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}:pr-${PRNUM}"
            
            echo "Starting container and running health checks..."
            docker run -d --name ${APP}-test \
              -e DISCORD_TOKEN=test \
              -e DEBUG_MODE=true \
              -e CI_SMOKE_MODE=true \
              -e CI=true \
              -e NODE_ENV=test \
              -e METRICS_PORT=3000 \
              "${IMAGE}"
            
            .circleci/scripts/container_health_check.sh ${APP}-test /live 180
            echo "Health check passed"
      - run:
          name: "Snyk Container Scan"
          command: |
            if [ -z "$SNYK_TOKEN" ]; then exit 0; fi
            npm install -g snyk@latest || true
            snyk auth $SNYK_TOKEN || true
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            snyk container test ghcr.io/${CIRCLE_PROJECT_USERNAME}/bunkbot:pr-${PRNUM} --severity-threshold=high || true

  docker_covabot:
    executor: docker
    steps:
      - checkout
      - attach_build_artifacts
      - setup_remote_docker
      - run:
          name: "[Phase 2] Build Docker Image"
          command: |
            set -e
            APP="covabot"
            DOCKERFILE="./src/covabot/Dockerfile.ci"
            
            HASH=$(git rev-parse HEAD:src/${APP} 2>/dev/null || echo "no-hash")
            SHARED_HASH=$(git rev-parse HEAD:src/shared 2>/dev/null || echo "no-shared")
            DEPS_HASH=$(sha256sum package-lock.json | cut -d' ' -f1 | head -c 12)
            CONTENT_HASH="${HASH:0:12}-${SHARED_HASH:0:12}-${DEPS_HASH}"
            
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
            
            IMAGE_BASE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}"
            IMAGE_CACHE="${IMAGE_BASE}:sha-${CONTENT_HASH}"
            IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_PULL_REQUEST##*/}"
            [ -z "$IMAGE_CURRENT" ] && IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_BUILD_NUM}"
            
            if docker pull "${IMAGE_CACHE}" 2>/dev/null; then
              echo "Using cached image: ${IMAGE_CACHE}"
              docker tag "${IMAGE_CACHE}" "${IMAGE_CURRENT}"
            else
              echo "Building fresh image (cache miss)"
              docker build -f "${DOCKERFILE}" \
                -t "${IMAGE_CURRENT}" \
                -t "${IMAGE_CACHE}" .
              docker push "${IMAGE_CACHE}"
            fi
            
            docker push "${IMAGE_CURRENT}"
      - run:
          name: "[Phase 3] Health Check"
          command: |
            set -e
            APP="covabot"
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            IMAGE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}:pr-${PRNUM}"
            
            echo "Starting container and running health checks..."
            docker run -d --name ${APP}-test \
              -e COVABOT_TOKEN=test \
              -e DISCORD_TOKEN=test \
              -e DEBUG_MODE=true \
              -e CI_SMOKE_MODE=true \
              -e CI=true \
              -e NODE_ENV=test \
              -e METRICS_PORT=3000 \
              "${IMAGE}"
            
            .circleci/scripts/container_health_check.sh ${APP}-test /live 180
            echo "Health check passed"
      - run:
          name: "Snyk Container Scan"
          command: |
            if [ -z "$SNYK_TOKEN" ]; then exit 0; fi
            npm install -g snyk@latest || true
            snyk auth $SNYK_TOKEN || true
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            snyk container test ghcr.io/${CIRCLE_PROJECT_USERNAME}/covabot:pr-${PRNUM} --severity-threshold=high || true

  docker_djcova:
    executor: docker
    steps:
      - checkout
      - attach_build_artifacts
      - setup_remote_docker
      - run:
          name: "[Phase 2] Build Docker Image"
          command: |
            set -e
            APP="djcova"
            DOCKERFILE="./src/djcova/Dockerfile.ci"
            
            HASH=$(git rev-parse HEAD:src/${APP} 2>/dev/null || echo "no-hash")
            SHARED_HASH=$(git rev-parse HEAD:src/shared 2>/dev/null || echo "no-shared")
            DEPS_HASH=$(sha256sum package-lock.json | cut -d' ' -f1 | head -c 12)
            CONTENT_HASH="${HASH:0:12}-${SHARED_HASH:0:12}-${DEPS_HASH}"
            
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
            
            IMAGE_BASE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}"
            IMAGE_CACHE="${IMAGE_BASE}:sha-${CONTENT_HASH}"
            IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_PULL_REQUEST##*/}"
            [ -z "$IMAGE_CURRENT" ] && IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_BUILD_NUM}"
            
            if docker pull "${IMAGE_CACHE}" 2>/dev/null; then
              echo "Using cached image: ${IMAGE_CACHE}"
              docker tag "${IMAGE_CACHE}" "${IMAGE_CURRENT}"
            else
              echo "Building fresh image (cache miss)"
              docker build -f "${DOCKERFILE}" \
                -t "${IMAGE_CURRENT}" \
                -t "${IMAGE_CACHE}" .
              docker push "${IMAGE_CACHE}"
            fi
            
            docker push "${IMAGE_CURRENT}"
      - run:
          name: "[Phase 3] Health Check"
          command: |
            set -e
            APP="djcova"
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            IMAGE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}:pr-${PRNUM}"
            
            echo "Starting container and running health checks..."
            docker run -d --name ${APP}-test \
              -e DEBUG_MODE=true \
              -e CI_SMOKE_MODE=true \
              -e CI=true \
              -e NODE_ENV=test \
              -e METRICS_PORT=3000 \
              "${IMAGE}"
            
            .circleci/scripts/container_health_check.sh ${APP}-test /live 180
            echo "Health check passed"
      - run:
          name: "Snyk Container Scan"
          command: |
            if [ -z "$SNYK_TOKEN" ]; then exit 0; fi
            npm install -g snyk@latest || true
            snyk auth $SNYK_TOKEN || true
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            snyk container test ghcr.io/${CIRCLE_PROJECT_USERNAME}/djcova:pr-${PRNUM} --severity-threshold=high || true

  docker_bluebot:
    executor: docker
    steps:
      - checkout
      - attach_build_artifacts
      - setup_remote_docker
      - run:
          name: "[Phase 2] Build Docker Image"
          command: |
            set -e
            APP="bluebot"
            DOCKERFILE="./src/bluebot/Dockerfile.ci"
            
            HASH=$(git rev-parse HEAD:src/${APP} 2>/dev/null || echo "no-hash")
            SHARED_HASH=$(git rev-parse HEAD:src/shared 2>/dev/null || echo "no-shared")
            DEPS_HASH=$(sha256sum package-lock.json | cut -d' ' -f1 | head -c 12)
            CONTENT_HASH="${HASH:0:12}-${SHARED_HASH:0:12}-${DEPS_HASH}"
            
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
            
            IMAGE_BASE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}"
            IMAGE_CACHE="${IMAGE_BASE}:sha-${CONTENT_HASH}"
            IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_PULL_REQUEST##*/}"
            [ -z "$IMAGE_CURRENT" ] && IMAGE_CURRENT="${IMAGE_BASE}:pr-${CIRCLE_BUILD_NUM}"
            
            if docker pull "${IMAGE_CACHE}" 2>/dev/null; then
              echo "Using cached image: ${IMAGE_CACHE}"
              docker tag "${IMAGE_CACHE}" "${IMAGE_CURRENT}"
            else
              echo "Building fresh image (cache miss)"
              docker build -f "${DOCKERFILE}" \
                -t "${IMAGE_CURRENT}" \
                -t "${IMAGE_CACHE}" .
              docker push "${IMAGE_CACHE}"
            fi
            
            docker push "${IMAGE_CURRENT}"
      - run:
          name: "[Phase 3] Health Check"
          command: |
            set -e
            APP="bluebot"
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            IMAGE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${APP}:pr-${PRNUM}"
            
            echo "Starting container and running health checks..."
            docker run -d --name ${APP}-test \
              -e DISCORD_TOKEN=test \
              -e DEBUG_MODE=true \
              -e CI_SMOKE_MODE=true \
              -e CI=true \
              -e NODE_ENV=test \
              -e METRICS_PORT=3000 \
              "${IMAGE}"
            
            .circleci/scripts/container_health_check.sh ${APP}-test /live 180
            echo "Health check passed"
      - run:
          name: "Snyk Container Scan"
          command: |
            if [ -z "$SNYK_TOKEN" ]; then exit 0; fi
            npm install -g snyk@latest || true
            snyk auth $SNYK_TOKEN || true
            PRNUM=${CIRCLE_PULL_REQUEST##*/}
            [ -z "$PRNUM" ] && PRNUM=${CIRCLE_BUILD_NUM}
            snyk container test ghcr.io/${CIRCLE_PROJECT_USERNAME}/bluebot:pr-${PRNUM} --severity-threshold=high || true

workflows:
  pr_validation:
    jobs:
      # PHASE 1: CODE QUALITY GATES
      - detect_changes
      - lint_and_format:
          requires: [detect_changes]
      - type_check:
          requires: [detect_changes]
      - build_apps:
          requires: [detect_changes]
      - unit_tests:
          requires: [detect_changes]
      - snyk_code_scan:
          requires: [detect_changes]

      # PHASE 2 & 3: CONDITIONAL DOCKER BUILD + HEALTH CHECK
      - docker_bunkbot:
          requires: [build_apps, lint_and_format, type_check, unit_tests]
      - docker_covabot:
          requires: [build_apps, lint_and_format, type_check, unit_tests]
      - docker_djcova:
          requires: [build_apps, lint_and_format, type_check, unit_tests]
      - docker_bluebot:
          requires: [build_apps, lint_and_format, type_check, unit_tests]
