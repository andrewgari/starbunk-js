version: 2.1

executors:
  node:
    docker:
      - image: cimg/node:20.12
    working_directory: ~/project
    environment:
      NODE_ENV: test
      CI: true

commands:
  npm_install:
    description: Checkout repo and install dependencies with caching
    steps:
      - checkout
      - restore_cache:
          name: Restore npm cache
          keys:
            - v1-npm-cache-{{ checksum "package-lock.json" }}
            - v1-npm-cache-
      - run:
          name: Install dependencies
          command: npm ci
      - save_cache:
          name: Save npm cache
          key: v1-npm-cache-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
      - persist_to_workspace:
          root: .
          paths:
            - .

jobs:
  install:
    executor: node
    steps:
      - npm_install

  validations:
    executor: node
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run structure/naming/docs validations
          command: npm run validate:structure

  lint-and-format:
    executor: node
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: ESLint
          command: npm run lint -- --cache --cache-location .eslintcache
      - run:
          name: Prettier check
          command: npm run format -- --check

  type-check:
    executor: node
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Type check all packages
          command: npm run type-check

  build:
    executor: node
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Build all packages
          command: |
            echo "Cleaning previous build artifacts"
            npm run clean
            echo "Building workspace"
            npm run build

  tests:
    executor: node
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run unit tests
          command: npm run test

workflows:
  version: 2.1
  pr-validation:
    jobs:
      - install
      - validations:
          requires:
            - install
      - lint-and-format:
          requires:
            - install
      - type-check:
          requires:
            - install
      - build:
          requires:
            - validations
            - lint-and-format
            - type-check
      - tests:
          requires:
            - build
