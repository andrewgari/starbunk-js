version: '3.8'

services:
  bunkbot:
    build:
      context: ../..
      dockerfile: src/bunkbot/Dockerfile
      args:
        NODE_ENV: development
        DEBUG_MODE: "true"
        LOG_LEVEL: debug
        ENABLE_METRICS: "true"
        ENABLE_STRUCTURED_LOGGING: "true"
    container_name: bunkbot-dev
    restart: unless-stopped
    env_file:
      - ../../.env
    environment:
      - NODE_ENV=development
      - DEBUG_MODE=true
      - LOG_LEVEL=debug
      - DISCORD_TOKEN=${BUNKBOT_TOKEN}
      - BUNKBOT_TOKEN=${BUNKBOT_TOKEN}
      - CLIENT_ID=${BUNKBOT_CLIENT_ID}
      - BUNKBOT_BOTS_DIR=/app/config
      # Observability
      - ENABLE_METRICS=true
      - ENABLE_STRUCTURED_LOGGING=true
      - METRICS_PORT=3000
    volumes:
      # Mount the bot configuration directory for live editing
      - ../../config/bunkbot:/app/config:ro
      # Optional: Mount source for development (requires dev image with ts-node)
      # - ./src:/app/src:ro
    ports:
      - "3000:3000"  # Metrics and health endpoint
    networks:
      - bunkbot-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - com.starbunk.service=bunkbot-dev
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000

networks:
  bunkbot-network:
    driver: bridge

