name: Release

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write

jobs:
  tag-release:
    name: ðŸ·ï¸ Tag ${{ matrix.container }} for release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container: [bunkbot, djcova, starbunk-dnd, covabot]
    steps:
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Tag latest with environment and version
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.container }}"
          VERSION="${{ github.event.release.tag_name }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"

          # Determine environment tag based on release type
          if [ "$IS_PRERELEASE" = "true" ]; then
            ENV_TAG="staging"
            echo "ðŸ·ï¸ Pre-release detected - tagging as staging"
          else
            ENV_TAG="prod"
            echo "ðŸ·ï¸ Full release detected - tagging as prod"
          fi

          echo "ðŸ·ï¸ Tagging $IMAGE:latest as $ENV_TAG and $VERSION"

          # Use buildx imagetools to add tags without rebuilding
          docker buildx imagetools create \
            --tag "$IMAGE:$ENV_TAG" \
            --tag "$IMAGE:$VERSION" \
            "$IMAGE:latest"

          echo "âœ… Tagged ${{ matrix.container }}:$ENV_TAG and ${{ matrix.container }}:$VERSION"

  release-summary:
    name: ðŸ“‹ Release Summary
    runs-on: ubuntu-latest
    needs: tag-release
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"

          # Determine environment tag based on release type
          if [ "$IS_PRERELEASE" = "true" ]; then
            ENV_TAG="staging"
            RELEASE_TYPE="Pre-Release"
            ENV_EMOJI="ðŸ§ª"
          else
            ENV_TAG="prod"
            RELEASE_TYPE="Production Release"
            ENV_EMOJI="ðŸš€"
          fi

          echo "## $ENV_EMOJI $RELEASE_TYPE $VERSION Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Container Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Container | Environment Tag | Version Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----------------|-------------|" >> $GITHUB_STEP_SUMMARY
          for container in bunkbot djcova starbunk-dnd covabot; do
            echo "| $container | \`ghcr.io/${{ github.repository_owner }}/$container:$ENV_TAG\` | \`ghcr.io/${{ github.repository_owner }}/$container:$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull $ENV_TAG versions" >> $GITHUB_STEP_SUMMARY
          for container in bunkbot djcova starbunk-dnd covabot; do
            echo "docker pull ghcr.io/${{ github.repository_owner }}/$container:$ENV_TAG" >> $GITHUB_STEP_SUMMARY
          done
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

