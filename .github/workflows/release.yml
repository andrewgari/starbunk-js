name: Release

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  CONTAINERS_JSON: '["bunkbot", "djcova", "starbunk-dnd", "covabot"]'

permissions:
  contents: read
  packages: write

jobs:
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    outputs:
      containers: ${{ steps.define-containers.outputs.containers }}
      containers-json: ${{ steps.define-containers.outputs.containers-json }}
    steps:
      - name: Define container list
        id: define-containers
        run: |
          # Define the container list in one place
          CONTAINERS="bunkbot djcova starbunk-dnd covabot"

          # Generate JSON array from the space-separated list
          CONTAINERS_JSON=$(echo "$CONTAINERS" | jq -Rc 'split(" ")')

          echo "containers=$CONTAINERS" >> $GITHUB_OUTPUT
          echo "containers-json=$CONTAINERS_JSON" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Container list: $CONTAINERS"
  determine-environment:
    name: ðŸ” Determine Environment
    runs-on: ubuntu-latest
    outputs:
      env-tag: ${{ steps.determine.outputs.env-tag }}
      release-type: ${{ steps.determine.outputs.release-type }}
      env-emoji: ${{ steps.determine.outputs.env-emoji }}
    steps:
      - name: Determine environment tag based on release type
        id: determine
        run: |
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "env-tag=staging" >> $GITHUB_OUTPUT
            echo "release-type=Pre-Release" >> $GITHUB_OUTPUT
            echo "env-emoji=ðŸ§ª" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Pre-release detected - environment is staging"
          else
            echo "env-tag=prod" >> $GITHUB_OUTPUT
            echo "release-type=Production Release" >> $GITHUB_OUTPUT
            echo "env-emoji=ðŸš€" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Full release detected - environment is prod"
          fi

  tag-release:
    name: ðŸ·ï¸ Tag ${{ matrix.container }} for release
    runs-on: ubuntu-latest
    needs: [setup, determine-environment]
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.setup.outputs.containers-json) }}
    steps:
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Tag latest with environment and version
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.container }}"
          VERSION="${{ github.event.release.tag_name }}"
          ENV_TAG="${{ needs.determine-environment.outputs.env-tag }}"

          echo "ðŸ·ï¸ Tagging $IMAGE:latest as $ENV_TAG and $VERSION"

          # Use buildx imagetools to add tags without rebuilding
          docker buildx imagetools create \
            --tag "$IMAGE:$ENV_TAG" \
            --tag "$IMAGE:$VERSION" \
            "$IMAGE:latest"

          echo "âœ… Tagged ${{ matrix.container }}:$ENV_TAG and ${{ matrix.container }}:$VERSION"

  release-summary:
    name: ðŸ“‹ Release Summary
    runs-on: ubuntu-latest
    needs: [determine-environment, tag-release]
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          ENV_TAG="${{ needs.determine-environment.outputs.env-tag }}"
          RELEASE_TYPE="${{ needs.determine-environment.outputs.release-type }}"
          ENV_EMOJI="${{ needs.determine-environment.outputs.env-emoji }}"

          # Parse container list from JSON env variable
          CONTAINERS=$(echo '${{ env.CONTAINERS_JSON }}' | jq -r 'join(" ")')

          echo "## $ENV_EMOJI $RELEASE_TYPE $VERSION Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Container Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Container | Environment Tag | Version Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----------------|-------------|" >> $GITHUB_STEP_SUMMARY
          for container in $CONTAINERS; do
            echo "| $container | \`ghcr.io/${{ github.repository_owner }}/$container:$ENV_TAG\` | \`ghcr.io/${{ github.repository_owner }}/$container:$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull $ENV_TAG versions" >> $GITHUB_STEP_SUMMARY
          for container in $CONTAINERS; do
            echo "docker pull ghcr.io/${{ github.repository_owner }}/$container:$ENV_TAG" >> $GITHUB_STEP_SUMMARY
          done
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
