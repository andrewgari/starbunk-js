name: PR - Validation & Build

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

env:
  REGISTRY: ghcr.io
  NODE_VERSION: '20'

permissions:
  contents: write
  packages: write
  pull-requests: read

concurrency:
  group: pr-validation-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # GROUP 1: CODE QUALITY (no dependencies)
  # =============================================================================

  lint-and-format:
    name: Validate Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run Prettier
        run: npm run format -- --check

  type-check:
    name: Validate Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

  # =============================================================================
  # GROUP 2: BUILD & TESTS (no dependencies)
  # =============================================================================

  build:
    name: Validate Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all applications
        run: npm run build

  unit-tests:
    name: Validate Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test

  # =============================================================================
  # GROUP 3: DOCKER BUILDS (no dependencies)
  # =============================================================================

  docker-build-bunkbot:
    name: Validate Docker Build - bunkbot
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/bunkbot/Dockerfile
          push: false
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/bunkbot:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/bunkbot.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bunkbot-image
          path: /tmp/bunkbot.tar
          retention-days: 1

  docker-build-covabot:
    name: Validate Docker Build - covabot
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/covabot/Dockerfile
          push: false
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/covabot:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/covabot.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: covabot-image
          path: /tmp/covabot.tar
          retention-days: 1

  docker-build-djcova:
    name: Validate Docker Build - djcova
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/djcova/Dockerfile
          push: false
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/djcova:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/djcova.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: djcova-image
          path: /tmp/djcova.tar
          retention-days: 1
  # =============================================================================
  # GROUP 4: VERSION VALIDATION (no dependencies)
  # =============================================================================

  version-check:
    name: Validate Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check and bump version if needed
        run: |
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:VERSION | tr -d '\n')
          PR_VERSION=$(cat VERSION | tr -d '\n')

          echo "Main version: $MAIN_VERSION"
          echo "PR version: $PR_VERSION"

          # Function to compare semantic versions
          # Returns 0 if PR_VERSION > MAIN_VERSION, 1 otherwise
          version_is_greater() {
            local main_ver=$1
            local pr_ver=$2
            
            IFS='.' read -r main_major main_minor main_patch <<< "$main_ver"
            IFS='.' read -r pr_major pr_minor pr_patch <<< "$pr_ver"
            
            if [ "$pr_major" -gt "$main_major" ]; then
              return 0
            elif [ "$pr_major" -eq "$main_major" ]; then
              if [ "$pr_minor" -gt "$main_minor" ]; then
                return 0
              elif [ "$pr_minor" -eq "$main_minor" ]; then
                if [ "$pr_patch" -gt "$main_patch" ]; then
                  return 0
                fi
              fi
            fi
            return 1
          }

          # Check if version needs to be bumped
          if version_is_greater "$MAIN_VERSION" "$PR_VERSION"; then
            echo "‚úÖ Version is already properly incremented from $MAIN_VERSION to $PR_VERSION"
            exit 0
          fi

          # Version needs to be bumped
          echo "‚ö†Ô∏è  Version needs to be bumped (current: $PR_VERSION, main: $MAIN_VERSION)"
          
          # Bump patch version
          IFS='.' read -r major minor patch <<< "$MAIN_VERSION"
          NEW_PATCH=$((patch + 1))
          NEW_VERSION="$major.$minor.$NEW_PATCH"
          echo "$NEW_VERSION" > VERSION
          echo "üìù Bumped version from $MAIN_VERSION to $NEW_VERSION"

          # Setup Node for sync-versions script
          echo "Setting up Node.js..."

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync versions and commit if changed
        run: |
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:VERSION | tr -d '\n')
          PR_VERSION=$(cat VERSION | tr -d '\n')
          
          # Function to compare semantic versions
          version_is_greater() {
            local main_ver=$1
            local pr_ver=$2
            
            IFS='.' read -r main_major main_minor main_patch <<< "$main_ver"
            IFS='.' read -r pr_major pr_minor pr_patch <<< "$pr_ver"
            
            if [ "$pr_major" -gt "$main_major" ]; then
              return 0
            elif [ "$pr_major" -eq "$main_major" ]; then
              if [ "$pr_minor" -gt "$main_minor" ]; then
                return 0
              elif [ "$pr_minor" -eq "$main_minor" ]; then
                if [ "$pr_patch" -gt "$main_patch" ]; then
                  return 0
                fi
              fi
            fi
            return 1
          }
          
          # Only proceed if version was bumped
          if ! version_is_greater "$MAIN_VERSION" "$PR_VERSION"; then
            echo "Running sync-versions script..."
            if [ ! -f "./scripts/sync-versions.sh" ]; then
              echo "‚ùå Error: sync-versions.sh script not found"
              exit 1
            fi
            if [ ! -x "./scripts/sync-versions.sh" ]; then
              chmod +x ./scripts/sync-versions.sh
            fi
            bash ./scripts/sync-versions.sh
            
            # Commit changes
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add VERSION package.json apps/*/package.json packages/*/package.json
            
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "chore: bump version to $PR_VERSION"
              git push
              echo "‚úÖ Version bumped and committed"
            fi
          else
            echo "‚úÖ Version already correct, no changes needed"
          fi

  # =============================================================================
  # CONTAINER VALIDATION & PUBLISHING (depends on docker builds)
  # =============================================================================

  validate-bunkbot:
    name: Validate Container - bunkbot
    runs-on: ubuntu-latest
    needs: [docker-build-bunkbot]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bunkbot-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/bunkbot.tar

      - name: Start container
        run: |
          docker run -d --name bunkbot-test             -e DISCORD_TOKEN=test             -e DEBUG_MODE=true             -e CI_SMOKE_MODE=true             -e CI=true             -e NODE_ENV=test             -e HEALTH_PORT=3000             ${{ env.REGISTRY }}/${{ github.repository_owner }}/bunkbot:pr-${{ github.event.pull_request.number }}

      - name: Wait for container to start
        run: sleep 10

      - name: Health check
        run: |
          MAX_RETRIES=30
          RETRY_COUNT=0
          until docker exec bunkbot-test curl -f http://127.0.0.1:3000/health || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            echo "Waiting for health check... ($RETRY_COUNT/$MAX_RETRIES)"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 2
          done
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Health check failed"
            docker logs bunkbot-test
            exit 1
          fi
          echo "Health check passed"

      - name: Smoke test
        run: |
          RESPONSE=$(docker exec bunkbot-test curl -s http://127.0.0.1:3000/health)
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "ok\|healthy\|UP"; then
            echo "Smoke test passed"
          else
            echo "Smoke test failed"
            exit 1
          fi

      - name: Show logs on failure
        if: failure()
        run: docker logs bunkbot-test

      - name: Cleanup
        if: always()
        run: docker rm -f bunkbot-test || true

  validate-covabot:
    name: Validate Container - covabot
    runs-on: ubuntu-latest
    needs: [docker-build-covabot]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: covabot-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/covabot.tar

      - name: Start container
        run: |
          docker run -d --name covabot-test             -e DISCORD_TOKEN=test             -e DEBUG_MODE=true             -e CI_SMOKE_MODE=true             -e CI=true             -e NODE_ENV=test             -e HEALTH_PORT=3000             ${{ env.REGISTRY }}/${{ github.repository_owner }}/covabot:pr-${{ github.event.pull_request.number }}

      - name: Wait for container to start
        run: sleep 10

      - name: Health check
        run: |
          MAX_RETRIES=30
          RETRY_COUNT=0
          until docker exec covabot-test curl -f http://127.0.0.1:3000/health || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            echo "Waiting for health check... ($RETRY_COUNT/$MAX_RETRIES)"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 2
          done
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Health check failed"
            docker logs covabot-test
            exit 1
          fi
          echo "Health check passed"

      - name: Smoke test
        run: |
          RESPONSE=$(docker exec covabot-test curl -s http://127.0.0.1:3000/health)
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "ok\|healthy\|UP"; then
            echo "Smoke test passed"
          else
            echo "Smoke test failed"
            exit 1
          fi

      - name: Show logs on failure
        if: failure()
        run: docker logs covabot-test

      - name: Cleanup
        if: always()
        run: docker rm -f covabot-test || true

  validate-djcova:
    name: Validate Container - djcova
    runs-on: ubuntu-latest
    needs: [docker-build-djcova]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: djcova-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/djcova.tar

      - name: Start container
        run: |
          docker run -d --name djcova-test             -e DISCORD_TOKEN=test             -e DEBUG_MODE=true             -e CI_SMOKE_MODE=true             -e CI=true             -e NODE_ENV=test             -e HEALTH_PORT=3000             ${{ env.REGISTRY }}/${{ github.repository_owner }}/djcova:pr-${{ github.event.pull_request.number }}

      - name: Wait for container to start
        run: sleep 10

      - name: Health check
        run: |
          MAX_RETRIES=30
          RETRY_COUNT=0
          until docker exec djcova-test curl -f http://127.0.0.1:3000/health || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            echo "Waiting for health check... ($RETRY_COUNT/$MAX_RETRIES)"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 2
          done
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Health check failed"
            docker logs djcova-test
            exit 1
          fi
          echo "Health check passed"

      - name: Smoke test
        run: |
          RESPONSE=$(docker exec djcova-test curl -s http://127.0.0.1:3000/health)
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "ok\|healthy\|UP"; then
            echo "Smoke test passed"
          else
            echo "Smoke test failed"
            exit 1
          fi

      - name: Show logs on failure
        if: failure()
        run: docker logs djcova-test

      - name: Cleanup
        if: always()
        run: docker rm -f djcova-test || true

  publish-bunkbot:
    name: Publish Image - bunkbot
    runs-on: ubuntu-latest
    needs: [validate-bunkbot]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bunkbot-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/bunkbot.tar

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image
        run: |
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/bunkbot:pr-${{ github.event.pull_request.number }}

  publish-covabot:
    name: Publish Image - covabot
    runs-on: ubuntu-latest
    needs: [validate-covabot]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: covabot-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/covabot.tar

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image
        run: |
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/covabot:pr-${{ github.event.pull_request.number }}

  publish-djcova:
    name: Publish Image - djcova
    runs-on: ubuntu-latest
    needs: [validate-djcova]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: djcova-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/djcova.tar

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image
        run: |
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/djcova:pr-${{ github.event.pull_request.number }}

  # =============================================================================
  # VALIDATION COMPLETE (final gate)
  # =============================================================================

  validation-complete:
    name: Validation Complete
    runs-on: ubuntu-latest
    needs:
      - lint-and-format
      - type-check
      - build
      - unit-tests
      - version-check
      - publish-bunkbot
      - publish-covabot
      - publish-djcova
    steps:
      - name: All checks passed
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ All validation checks passed!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úì Lint & Format"
          echo "‚úì Type Check"
          echo "‚úì Build"
          echo "‚úì Unit Tests"
          echo "‚úì Version Check"
          echo "‚úì Docker Builds (4 apps)"
          echo "‚úì Container Validation (4 apps)"
          echo "‚úì Image Publishing (4 apps)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
