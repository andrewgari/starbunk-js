name: Docker Build

on:
    workflow_call: {}
    pull_request:
        types: [opened, synchronize]
        paths:
            - 'Dockerfile'
            - 'docker-compose.yml'
            - '.dockerignore'
            - 'src/**/*'
            - 'public/**/*'
            - 'package.json'
            - 'package-lock.json'
            - '.github/workflows/docker-build.yml'
    workflow_dispatch:

jobs:
    docker-build:
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”§ Create empty yarn.lock if it doesn't exist
              run: |
                  if [ ! -f yarn.lock ]; then
                    echo "Creating empty yarn.lock file"
                    touch yarn.lock
                  fi

            - name: ðŸ³ Docker Build
              run: |
                  echo "::group::Building Docker image"
                  DOCKER_BUILDKIT=1 docker build --no-cache -t ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }} .
                  echo "::endgroup::"
                  echo "âœ… Docker image built: ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }}"

            - name: ðŸ“ Docker Build Summary
              run: |
                  echo "### ðŸ³ Docker Build Results" >> $GITHUB_STEP_SUMMARY
                  echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Repository** | ghcr.io/${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Tag** | pr-${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | ${{ job.status == 'success' && 'âœ… Built successfully' || 'âŒ Build failed' }} |" >> $GITHUB_STEP_SUMMARY
