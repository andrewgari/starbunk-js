# Grafana Dashboards for Starbunk Discord Bot

This directory contains Grafana dashboard configurations for monitoring the Starbunk Discord bot observability stack. These dashboards are designed to integrate with an existing Grafana instance and provide comprehensive monitoring for all bot containers.

## Dashboard Overview

### 1. System Overview (`system-overview.json`)
**Purpose**: High-level monitoring of all bot containers and system health
**Key Metrics**:
- System status and uptime across all services
- Total message processing rates
- Memory usage by service
- Circuit breaker status
- Top active channels

**Use Case**: Operations team dashboard for overall system health monitoring

### 2. BunkBot Metrics (`bunkbot-metrics.json`) 
**Purpose**: Detailed monitoring of reply bot performance and behavior
**Key Metrics**:
- Active reply bots count
- Bot trigger rates and success rates
- Response latency by bot
- Bot skip reasons and patterns
- Circuit breaker activations
- Channel activity heatmap

**Use Case**: Performance tuning and behavior analysis of individual reply bots

### 3. DJCova Music Service (`djcova-metrics.json`)
**Purpose**: Music service monitoring with voice channel focus
**Key Metrics**:
- Music command rates by type
- Active voice connections and duration
- Queue status and song processing
- Audio processing errors
- Music source popularity
- Command response times

**Use Case**: Music service reliability and user experience monitoring

### 4. Starbunk-DND Campaign Management (`starbunk-dnd-metrics.json`)
**Purpose**: D&D campaign system monitoring with AI/LLM focus
**Key Metrics**:
- Active campaigns and player counts
- LLM query rates and response times by provider
- Vector search performance
- Campaign message activity
- Character sheet operations
- Cross-server bridge activity
- AI error rates by provider and type

**Use Case**: Campaign management effectiveness and AI service performance

### 5. CovaBot AI Personality (`covabot-metrics.json`)
**Purpose**: AI personality bot monitoring with conversation analysis
**Key Metrics**:
- AI conversation rates
- Memory system performance
- Response sentiment analysis
- Personality trait distribution
- User engagement patterns
- LLM response times and error rates
- Conversation length analysis

**Use Case**: AI personality effectiveness and user interaction quality

## Prerequisites

### Prometheus Data Source
These dashboards expect metrics from a Prometheus instance collecting data from the Starbunk bot containers. The bot services use the shared observability system that exposes metrics in Prometheus format.

**Required Metrics** (auto-generated by the bot services):
- `discord_messages_processed_total`
- `bot_triggers_total`, `bot_responses_total`, `bot_skips_total`
- `bot_response_duration_ms_bucket` (histogram)
- `circuit_breaker_open`, `circuit_breaker_activations_total`
- `memory_usage_bytes`
- `channel_messages_per_minute`, `channel_active_users`
- Service-specific metrics (music, LLM, vector search, etc.)

### Environment Variables
The bot services should be configured with:
```bash
ENABLE_METRICS=true
PROMETHEUS_PUSHGATEWAY_URL=http://pushgateway:9091  # Optional
METRICS_PUSH_INTERVAL=30000  # Optional, defaults to 30s
ENABLE_STRUCTURED_LOGGING=true  # For enhanced log correlation
```

## Installation

### Option 1: Import via Grafana UI
1. Open your Grafana instance
2. Navigate to Dashboards â†’ Import
3. Upload the JSON file or paste the content
4. Configure the Prometheus data source
5. Adjust template variables if needed

### Option 2: Programmatic Import
```bash
# Using Grafana API
curl -X POST \
  -H "Authorization: Bearer $GRAFANA_API_KEY" \
  -H "Content-Type: application/json" \
  -d @system-overview.json \
  http://grafana:3000/api/dashboards/db
```

### Option 3: Provisioning
Add to your Grafana provisioning configuration:

```yaml
# dashboards.yml
apiVersion: 1
providers:
  - name: 'starbunk-dashboards'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /etc/grafana/provisioning/dashboards/starbunk
```

## Template Variables

### Global Variables (available in all dashboards):
- **`$service`**: Filter by bot service (bunkbot, djcova, starbunk-dnd, covabot)
- **`$guild_id`**: Filter by Discord server/guild
- **`$DS_PROMETHEUS`**: Prometheus data source (auto-configured)

### Dashboard-Specific Variables:
- **BunkBot**: `$bot` (reply bot name), `$channel` (channel name)
- **DJCova**: Voice channel filters
- **Starbunk-DND**: `$campaign` (campaign ID)
- **CovaBot**: `$user_id` (user interaction filtering)

## Alert Integration

### Recommended Alert Rules

**High-Level System Alerts**:
```yaml
- alert: BotServiceDown
  expr: up{job=~"starbunk.*"} == 0
  for: 2m
  
- alert: HighMemoryUsage
  expr: memory_usage_bytes{type="rss"} / 1024 / 1024 > 1000
  for: 5m
  
- alert: CircuitBreakerOpen  
  expr: circuit_breaker_open == 1
  for: 1m
```

**Service-Specific Alerts**:
```yaml
- alert: LowBotResponseRate
  expr: rate(bot_responses_total[5m]) / rate(bot_triggers_total[5m]) < 0.8
  for: 10m

- alert: HighLLMLatency
  expr: histogram_quantile(0.95, rate(llm_response_duration_ms_bucket[5m])) > 15000
  for: 5m

- alert: MusicServiceErrors
  expr: rate(music_errors_total[5m]) > 0.1
  for: 2m
```

## Dashboard Customization

### Adding Business Logic Panels
The dashboards focus on technical metrics but can be extended with business logic:

1. **User Engagement**: Track daily/weekly active users per service
2. **Feature Usage**: Monitor command popularity and adoption
3. **Campaign Health**: D&D campaign activity and player retention
4. **AI Effectiveness**: Sentiment trends and conversation quality

### Custom Queries
Example custom queries for business insights:

```promql
# Daily active users
count by (service) (
  count by (service, user_id) (
    increase(discord_messages_processed_total[1d])
  )
)

# Command popularity over time  
topk(10, 
  sum by (command) (
    increase(music_commands_total[1h])
  )
)

# AI conversation engagement
avg_over_time(
  covabot_conversation_length[1h]
) by (guild_id)
```

## Troubleshooting

### Missing Metrics
1. Verify bot services have `ENABLE_METRICS=true`
2. Check Prometheus scrape configuration
3. Confirm network connectivity between bots and Prometheus

### Template Variable Issues
1. Ensure Prometheus data source is properly configured
2. Verify label names match your metric structure
3. Check that services are actually producing metrics

### Performance Optimization
1. Adjust time ranges for large deployments
2. Use recording rules for expensive queries
3. Consider downsampling for long-term storage

## Monitoring Best Practices

### Dashboard Usage Patterns
- **System Overview**: Always-on NOC display
- **Service-Specific**: Deep-dive during investigations
- **Alert Context**: Link from alerts to relevant dashboard panels

### Data Retention
- High-resolution metrics: 15 days
- Medium resolution: 90 days  
- Long-term trends: 1 year (downsampled)

### Security Considerations
- Limit access to user-specific data (user IDs, message content)
- Use dashboard permissions for sensitive operational data
- Consider GDPR implications for user behavior tracking

## Contributing

When adding new metrics or modifying dashboards:

1. Update the corresponding bot service's metrics collection
2. Test queries against real data before committing
3. Update dashboard descriptions and variable help text
4. Consider backward compatibility with existing deployments
5. Document any new environment variables or configuration

## Support

For issues with these dashboards:
1. Check bot service logs for metric collection errors
2. Verify Prometheus scrape targets are healthy
3. Test Prometheus queries independently before using in Grafana
4. Review Grafana query inspector for debugging