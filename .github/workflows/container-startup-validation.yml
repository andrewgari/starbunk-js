name: Container Startup Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths:
      - 'apps/**'
      - 'shared/**'
      - '.github/workflows/container-startup-validation.yml'
      - '.github/workflows/code-quality-gates.yml'
      - '.github/workflows/build-metrics.yml'
      - '.github/workflows/pr-validation.yml'
      - '.github/path-filters*.yml'
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'shared/**'
      - '.github/workflows/container-startup-validation.yml'
      - '.github/workflows/code-quality-gates.yml'
      - '.github/workflows/build-metrics.yml'
      - '.github/workflows/pr-validation.yml'
      - '.github/path-filters*.yml'

# Allow manual triggering for testing
  workflow_dispatch:

env:
  # Test environment variables (safe for CI)
  STARBUNK_TOKEN: ${{ secrets.STARBUNK_TOKEN || 'test-token-placeholder-70-chars-long-for-validation-testing-purposes' }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-openai-key' }}
  OLLAMA_API_URL: ${{ secrets.OLLAMA_API_URL || 'http://localhost:11434' }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || '' }}
  DEBUG_MODE: 'true'
  TESTING_SERVER_IDS: '753251582719688714'
  TESTING_CHANNEL_IDS: '1234567890123456789'
  NODE_ENV: 'test'

jobs:
  detect-changes:
    name: Detect Container Changes
    runs-on: ubuntu-latest
    outputs:
      bunkbot: ${{ steps.changes.outputs.bunkbot }}
      covabot: ${{ steps.changes.outputs.covabot }}
      djcova: ${{ steps.changes.outputs.djcova }}
      starbunk-dnd: ${{ steps.changes.outputs.starbunk-dnd }}
      shared: ${{ steps.changes.outputs.shared }}
      container-validation: ${{ steps.changes.outputs.container-validation }}
      any-container: ${{ steps.set-flags.outputs.any-container }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: '.github/path-filters-optimized.yml'

      - name: Set validation flags
        id: set-flags
        run: |
          # Check if any container-related changes occurred
          if [[ "${{ steps.changes.outputs.bunkbot }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.covabot }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.djcova }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.starbunk-dnd }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.shared }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.container-validation }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.critical-infrastructure }}" == "true" ]]; then
            echo "any-container=true" >> $GITHUB_OUTPUT
            echo "ğŸ” Container validation will run - changes detected"
          else
            echo "any-container=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Container validation skipped - no relevant changes"
          fi

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-container == 'true'
    strategy:
      matrix:
        container: [bunkbot, covabot, djcova, starbunk-dnd]
        include:
          - container: bunkbot
            path: apps/bunkbot
            test-script: test:unit
          - container: covabot
            path: apps/covabot
            test-script: test:unit
          - container: djcova
            path: apps/djcova
            test-script: test
          - container: starbunk-dnd
            path: apps/starbunk-dnd
            test-script: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            packages/shared/package-lock.json
            ${{ matrix.path }}/package-lock.json

      - name: Install shared dependencies
        run: |
          cd packages/shared
          npm ci

      - name: Build shared library
        run: |
          cd packages/shared
          npm run build

      - name: Install container dependencies
        run: |
          cd ${{ matrix.path }}
          npm ci

      - name: Generate Prisma client
        run: |
          # Check for container-specific Prisma schema first
          cd ${{ matrix.path }}
          if [ -f "prisma/schema.prisma" ]; then
            echo "Found container-specific Prisma schema, generating client..."
            npx prisma generate
          # Check for root-level Prisma schema
          elif [ -f "../../prisma/schema.prisma" ]; then
            echo "Found root-level Prisma schema, generating client..."
            cd ../../
            npx prisma generate
            cd ${{ matrix.path }}
            # Copy the generated client to the container's node_modules
            if [ -d "../../node_modules/@prisma" ]; then
              echo "Copying Prisma client to container node_modules..."
              mkdir -p node_modules/@prisma
              cp -r ../../node_modules/@prisma/client node_modules/@prisma/
            fi
          else
            echo "No Prisma schema found, skipping generation"
          fi

      - name: Run unit tests
        env:
          CI: true
          NODE_ENV: test
        run: |
          cd ${{ matrix.path }}
          npm run ${{ matrix.test-script }}

  e2e-tests:
    name: E2E Tests (CovaBot)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.covabot == 'true' || needs.detect-changes.outputs.shared == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            packages/shared/package-lock.json
            apps/covabot/package-lock.json

      - name: Install shared dependencies
        run: |
          cd packages/shared
          npm ci

      - name: Build shared library
        run: |
          cd packages/shared
          npm run build

      - name: Install CovaBot dependencies
        run: |
          cd apps/covabot
          npm ci

      - name: Generate Prisma client
        run: |
          cd apps/covabot
          if [ -f "prisma/schema.prisma" ]; then
            echo "Found container-specific Prisma schema, generating client..."
            npx prisma generate
          elif [ -f "../../prisma/schema.prisma" ]; then
            echo "Found root-level Prisma schema, generating client..."
            cd ../../
            npx prisma generate
            cd apps/covabot
            if [ -d "../../node_modules/@prisma" ]; then
              echo "Copying Prisma client to container node_modules..."
              mkdir -p node_modules/@prisma
              cp -r ../../node_modules/@prisma/client node_modules/@prisma/
            fi
          else
            echo "No Prisma schema found, skipping generation"
          fi

      - name: Verify Ollama availability (optional)
        continue-on-error: true
        run: |
          echo "ğŸ” Checking Ollama availability..."
          if curl -f http://localhost:11434/api/tags 2>/dev/null; then
            echo "âœ… Ollama is available"
            echo "Available models:"
            curl -s http://localhost:11434/api/tags | jq -r '.models[].name' || echo "No models found"
          else
            echo "âš ï¸ Ollama is not available - tests will use mock LLM provider"
          fi

      - name: Run E2E tests
        env:
          CI: true
          NODE_ENV: test
          # Ollama configuration - uses Unraid Ollama instance
          OLLAMA_API_URL: http://localhost:11434
          # Test environment configuration
          STARBUNK_TOKEN: ${{ secrets.STARBUNK_TOKEN }}
          # DEBUG_MODE disabled for E2E tests - tests use TestUser, not Cova
          # (DEBUG_MODE=true enables calibration mode which only responds to Cova)
          DEBUG_MODE: 'false'
          TESTING_SERVER_IDS: '753251582719688714'
          TESTING_CHANNEL_IDS: '1234567890123456789'
        run: |
          cd apps/covabot
          npm run test:e2e

  covabot-filtering-tests:
    name: CovaBot Filtering Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.bunkbot == 'true' || needs.detect-changes.outputs.shared == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            packages/shared/package-lock.json
            apps/bunkbot/package-lock.json

      - name: Install shared dependencies
        run: |
          cd packages/shared
          npm ci

      - name: Build shared library
        run: |
          cd packages/shared
          npm run build

      - name: Install BunkBot dependencies
        run: |
          cd apps/bunkbot
          npm ci

      - name: Run CovaBot filtering tests
        run: |
          cd apps/bunkbot
          npm test -- --testPathPattern="covabot-filtering" --verbose

  container-startup-tests:
    name: Container Startup Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-container == 'true'
    strategy:
      matrix:
        container: [bunkbot]
        include:
          - container: bunkbot
            path: apps/bunkbot
            dockerfile: apps/bunkbot/Dockerfile
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            packages/shared/package-lock.json
            ${{ matrix.path }}/package-lock.json

      - name: Install shared dependencies
        run: |
          cd packages/shared
          npm ci

      - name: Build shared library
        run: |
          cd packages/shared
          npm run build

      - name: Install container dependencies
        run: |
          cd ${{ matrix.path }}
          npm ci

      - name: Run container startup unit tests
        run: |
          cd ${{ matrix.path }}
          npm run test:container

  validation-summary:
    name: Container Validation Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, unit-tests, e2e-tests, covabot-filtering-tests, container-startup-tests]
    if: always() && needs.detect-changes.outputs.any-container == 'true'
    steps:
      - name: Check test results
        run: |
          echo "## Container Startup Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
            echo "âœ… **Unit Tests**: All container unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Unit Tests**: Some unit tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "âœ… **E2E Tests**: CovaBot LLM integration tests passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
            echo "â­ï¸ **E2E Tests**: Tests skipped (no relevant changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **E2E Tests**: CovaBot E2E tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.covabot-filtering-tests.result }}" == "success" ]]; then
            echo "âœ… **CovaBot Filtering**: Enhanced bot filtering tests passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.covabot-filtering-tests.result }}" == "skipped" ]]; then
            echo "â­ï¸ **CovaBot Filtering**: Tests skipped (no relevant changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **CovaBot Filtering**: Bot filtering tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.container-startup-tests.result }}" == "success" ]]; then
            echo "âœ… **Container Startup**: All startup validation tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Container Startup**: Some startup tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: Core component functionality" >> $GITHUB_STEP_SUMMARY
          echo "- **E2E Tests**: CovaBot LLM integration with Ollama" >> $GITHUB_STEP_SUMMARY
          echo "- **CovaBot Filtering**: Enhanced bot response filtering" >> $GITHUB_STEP_SUMMARY
          echo "- **Container Startup**: Service initialization and Discord connection" >> $GITHUB_STEP_SUMMARY

          # Fail if any required tests failed
          if [[ "${{ needs.unit-tests.result }}" != "success" ]] ||
             [[ "${{ needs.e2e-tests.result }}" != "success" ]] ||
             [[ "${{ needs.container-startup-tests.result }}" != "success" ]] ||
             [[ "${{ needs.covabot-filtering-tests.result }}" == "failure" ]]; then
            echo "âŒ Container validation failed - check individual test results"
            exit 1
          fi

          echo "âœ… All container validation tests passed successfully!"
