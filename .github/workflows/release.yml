name: Release - Promote Images

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  REGISTRY_PREFIX: ghcr.io/${{ github.repository_owner }}

permissions:
  contents: read
  packages: write

jobs:
  determine-environment:
    name: ðŸ” Determine Environment
    runs-on: ubuntu-latest
    outputs:
      env-tag: ${{ steps.determine.outputs.env-tag }}
      release-type: ${{ steps.determine.outputs.release-type }}
      env-emoji: ${{ steps.determine.outputs.env-emoji }}
      containers: ${{ steps.determine.outputs.containers }}
    steps:
      - name: Determine environment and build settings
        id: determine
        run: |
          IS_PRERELEASE="${{ github.event.release.prerelease }}"

          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "env-tag=staging" >> $GITHUB_OUTPUT
            echo "release-type=Pre-Release" >> $GITHUB_OUTPUT
            echo "env-emoji=ðŸ§ª" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Pre-release detected - environment is staging"
          else
            echo "env-tag=prod" >> $GITHUB_OUTPUT
            echo "release-type=Production Release" >> $GITHUB_OUTPUT
            echo "env-emoji=ðŸš€" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Full release detected - environment is prod"
          fi

          # Output containers list for matrix strategy
          echo 'containers=["bunkbot", "djcova", "starbunk-dnd", "covabot"]' >> $GITHUB_OUTPUT

  promote-release:
    name: ðŸ·ï¸ Promote ${{ matrix.container }} to ${{ needs.determine-environment.outputs.env-tag }}
    runs-on: ubuntu-latest
    needs: determine-environment
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.determine-environment.outputs.containers) }}
    steps:
      - name: ðŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Pull Latest Image
        run: |
          echo "ðŸ“¥ Pulling latest image for ${{ matrix.container }}..."
          docker pull ${{ env.REGISTRY_PREFIX }}/${{ matrix.container }}:latest
          echo "âœ… Successfully pulled latest image"

      - name: ðŸ·ï¸ Re-tag Image for Release
        run: |
          ENV_TAG="${{ needs.determine-environment.outputs.env-tag }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          IMAGE_BASE="${{ env.REGISTRY_PREFIX }}/${{ matrix.container }}"

          echo "ðŸ·ï¸ Tagging image with environment tag: ${ENV_TAG}"
          docker tag ${IMAGE_BASE}:latest ${IMAGE_BASE}:${ENV_TAG}

          echo "ðŸ·ï¸ Tagging image with release version: ${RELEASE_TAG}"
          docker tag ${IMAGE_BASE}:latest ${IMAGE_BASE}:${RELEASE_TAG}

          echo "âœ… Image tagged successfully"

      - name: ðŸ“¤ Push Tagged Images
        run: |
          ENV_TAG="${{ needs.determine-environment.outputs.env-tag }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          IMAGE_BASE="${{ env.REGISTRY_PREFIX }}/${{ matrix.container }}"

          echo "ðŸ“¤ Pushing ${IMAGE_BASE}:${ENV_TAG}..."
          docker push ${IMAGE_BASE}:${ENV_TAG}

          echo "ðŸ“¤ Pushing ${IMAGE_BASE}:${RELEASE_TAG}..."
          docker push ${IMAGE_BASE}:${RELEASE_TAG}

          echo "âœ… All tags pushed successfully"

      - name: ðŸ“Š Promotion Summary
        run: |
          ENV_TAG="${{ needs.determine-environment.outputs.env-tag }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          ENV_EMOJI="${{ needs.determine-environment.outputs.env-emoji }}"
          IMAGE_BASE="${{ env.REGISTRY_PREFIX }}/${{ matrix.container }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$ENV_EMOJI Successfully promoted ${{ matrix.container }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ Source: ${IMAGE_BASE}:latest"
          echo "ðŸ·ï¸  Tags:"
          echo "   â€¢ ${IMAGE_BASE}:${ENV_TAG}"
          echo "   â€¢ ${IMAGE_BASE}:${RELEASE_TAG}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  release-summary:
    name: ðŸ“‹ Release Summary
    runs-on: ubuntu-latest
    needs: [determine-environment, promote-release]
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          ENV_TAG="${{ needs.determine-environment.outputs.env-tag }}"
          RELEASE_TYPE="${{ needs.determine-environment.outputs.release-type }}"
          ENV_EMOJI="${{ needs.determine-environment.outputs.env-emoji }}"

          # Convert containers JSON array to space-separated list
          CONTAINERS=$(echo '${{ needs.determine-environment.outputs.containers }}' | jq -r '. | join(" ")')

          echo "## $ENV_EMOJI $RELEASE_TYPE $VERSION Promoted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Promotion Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: Images tagged with \`:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`$ENV_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Type**: $RELEASE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Container Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Container | Environment Tag | Version Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----------------|-------------|" >> $GITHUB_STEP_SUMMARY
          for container in $CONTAINERS; do
            echo "| $container | \`ghcr.io/${{ github.repository_owner }}/$container:$ENV_TAG\` | \`ghcr.io/${{ github.repository_owner }}/$container:$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull $ENV_TAG versions" >> $GITHUB_STEP_SUMMARY
          for container in $CONTAINERS; do
            echo "docker pull ghcr.io/${{ github.repository_owner }}/$container:$ENV_TAG" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or pull specific version" >> $GITHUB_STEP_SUMMARY
          for container in $CONTAINERS; do
            echo "docker pull ghcr.io/${{ github.repository_owner }}/$container:$VERSION" >> $GITHUB_STEP_SUMMARY
          done
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
