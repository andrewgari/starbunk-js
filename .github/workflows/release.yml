name: Release

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write

jobs:
  tag-stable:
    name: ðŸ·ï¸ Tag ${{ matrix.container }} as stable
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container: [bunkbot, djcova, starbunk-dnd, covabot]
    steps:
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Tag latest as stable and version
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.container }}"
          VERSION="${{ github.event.release.tag_name }}"
          
          echo "ðŸ·ï¸ Tagging $IMAGE:latest as stable and $VERSION"
          
          # Use buildx imagetools to add tags without rebuilding
          docker buildx imagetools create \
            --tag "$IMAGE:stable" \
            --tag "$IMAGE:$VERSION" \
            "$IMAGE:latest"
          
          echo "âœ… Tagged ${{ matrix.container }}:stable and ${{ matrix.container }}:$VERSION"

  release-summary:
    name: ðŸ“‹ Release Summary
    runs-on: ubuntu-latest
    needs: tag-stable
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "## ðŸš€ Release $VERSION Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Container Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Container | Stable Tag | Version Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------|-------------|" >> $GITHUB_STEP_SUMMARY
          for container in bunkbot djcova starbunk-dnd covabot; do
            echo "| $container | \`ghcr.io/${{ github.repository_owner }}/$container:stable\` | \`ghcr.io/${{ github.repository_owner }}/$container:$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull stable versions" >> $GITHUB_STEP_SUMMARY
          for container in bunkbot djcova starbunk-dnd covabot; do
            echo "docker pull ghcr.io/${{ github.repository_owner }}/$container:stable" >> $GITHUB_STEP_SUMMARY
          done
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

