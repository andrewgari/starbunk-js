{
  "uid": "starbunk-overview",
  "title": "Starbunk Overview",
  "tags": ["starbunk", "bots", "observability"],
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "30s",
  "panels": [
    {
      "type": "stat",
      "title": "Services Up",
      "gridPos": { "x": 0, "y": 0, "w": 8, "h": 6 },
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": { "unit": "none", "thresholds": { "mode": "absolute", "steps": [ {"color": "red", "value": null}, {"color": "green", "value": 1} ] } },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false }, "orientation": "horizontal", "textMode": "value" },
      "targets": [
        {
          "expr": "sum(up{com_starbunk_service!=\"\"})",
          "legendFormat": "",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "CPU (user seconds rate)",
      "gridPos": { "x": 8, "y": 0, "w": 16, "h": 6 },
      "datasource": "Prometheus",
      "fieldConfig": { "defaults": { "unit": "ops" }, "overrides": [] },
      "targets": [
        {
          "expr": "sum by (com_starbunk_service)(rate(process_cpu_user_seconds_total{com_starbunk_service!=\"\"}[5m]))",
          "legendFormat": "{{com_starbunk_service}}",
          "refId": "A"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "Memory (RSS bytes)",
      "gridPos": { "x": 0, "y": 6, "w": 12, "h": 8 },
      "datasource": "Prometheus",
      "fieldConfig": { "defaults": { "unit": "bytes" }, "overrides": [] },
      "targets": [
        {
          "expr": "sum by (com_starbunk_service)(process_resident_memory_bytes{com_starbunk_service!=\"\"})",
          "legendFormat": "{{com_starbunk_service}}",
          "refId": "A"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "Event Loop Lag (p75)",
      "gridPos": { "x": 12, "y": 6, "w": 12, "h": 8 },
      "datasource": "Prometheus",
      "fieldConfig": { "defaults": { "unit": "s" }, "overrides": [] },
      "targets": [
        {
          "expr": "avg by (com_starbunk_service)(nodejs_eventloop_lag_seconds{quantile=\"0.75\", com_starbunk_service!=\"\"})",
          "legendFormat": "{{com_starbunk_service}}",
          "refId": "A"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "logs",
      "title": "Container Logs (Loki)",
      "gridPos": { "x": 0, "y": 14, "w": 24, "h": 10 },
      "datasource": "Loki",
      "options": {
        "dedupStrategy": "none",
        "enableLogDetails": true,
        "prettifyLogMessage": true,
        "showLabels": false,
        "wrapLogMessage": true
      },
      "targets": [
        {
          "expr": "{com_starbunk_service!=\"\"}",
          "refId": "A"
        }
      ]
    }
  ],
  "templating": {
    "list": [
      {
        "name": "service",
        "label": "Service",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(up{com_starbunk_service!=\"\"}, com_starbunk_service)",
        "refresh": 2,
        "includeAll": true,
        "multi": true
      }
    ]
  },
  "time": { "from": "now-6h", "to": "now" }
}

