version: 2.1

# Shared executors for all module workflows
executors:
  node22:
    docker:
      - image: cimg/node:22.14
    resource_class: medium
  docker:
    docker:
      - image: cimg/base:stable
    resource_class: medium

# Shared commands for all module workflows
commands:
  setup_npm_cache:
    description: "Install npm dependencies with caching"
    steps:
      - restore_cache:
          keys:
            - v1-npm-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-{{ arch }}-{{ .Branch }}-
            - v1-npm-{{ arch }}-
      - run:
          name: Show Node and npm versions
          command: |
            node -v
            npm -v
      - run:
          name: Install dependencies
          command: npm ci
      - save_cache:
          key: v1-npm-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules

  persist_build_artifacts:
    description: "Compress and persist build artifacts to workspace"
    steps:
      - run:
          name: Compress build artifacts
          command: |
            # Build list of files to tar
            FILES_TO_TAR="package.json package-lock.json"
            for app in $(ls src); do
              if [ -d "src/$app/dist" ]; then
                FILES_TO_TAR="$FILES_TO_TAR src/$app/dist"
              fi
            done
            tar -czf build-artifacts.tar.gz $FILES_TO_TAR
            echo "Tarred files: $FILES_TO_TAR"
      - persist_to_workspace:
          root: .
          paths:
            - build-artifacts.tar.gz

  attach_build_artifacts:
    description: "Attach and extract build artifacts from workspace"
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Extract build artifacts
          command: tar -xzf build-artifacts.tar.gz

  setup_docker_cli:
    description: "Ensure Docker CLI is available"
    steps:
      - run:
          name: Ensure Docker CLI is available
          command: |
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y --no-install-recommends docker.io
            fi
            docker --version
  notify_discord:
    description: "Send deployment notification to Discord"
    parameters:
      status:
        type: string
        description: "Deployment status: started, success, failed"
      version:
        type: string
        default: "${CIRCLE_BRANCH}"
      message:
        type: string
        default: ""
    steps:
      - run:
          name: Send Discord Notification
          when: always
          command: |
            if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
              echo "WARNING: DISCORD_WEBHOOK_URL not configured - skipping notification"
              exit 0
            fi

            STATUS="<< parameters.status >>"
            VERSION="<< parameters.version >>"
            MESSAGE="<< parameters.message >>"

            case "$STATUS" in
              started)
                COLOR=3447003  # Blue
                EMOJI=":rocket:"
                TITLE="Deployment Started"
                ;;
              success)
                COLOR=3066993  # Green
                EMOJI=":white_check_mark:"
                TITLE="Deployment Successful"
                ;;
              failed)
                COLOR=15158332  # Red
                EMOJI=":x:"
                TITLE="Deployment Failed"
                ;;
              *)
                COLOR=10181046  # Purple
                EMOJI=":information_source:"
                TITLE="Deployment Update"
                ;;
            esac

            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            BUILD_URL="https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}"

            PAYLOAD=$(cat \<<-EOF
            {
              "embeds": [{
                "title": "${EMOJI} ${TITLE}",
                "description": "${MESSAGE}",
                "color": ${COLOR},
                "fields": [
                  {
                    "name": "Version/Branch",
                    "value": "\`${VERSION}\`",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "\`${CIRCLE_BRANCH:-N/A}\`",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "\`${CIRCLE_SHA1:0:7}\`",
                    "inline": true
                  },
                  {
                    "name": "Triggered By",
                    "value": "${CIRCLE_USERNAME:-CircleCI}",
                    "inline": true
                  }
                ],
                "timestamp": "${TIMESTAMP}",
                "footer": {
                  "text": "Starbunk Production Deployment"
                },
                "url": "${BUILD_URL}"
              }]
            }
            EOF
            )

            curl -H "Content-Type: application/json" \
                 -d "${PAYLOAD}" \
                 "${DISCORD_WEBHOOK_URL}"

  setup_ssh_config:
    description: "Setup SSH config for Unraid server access"
    steps:
      - run:
          name: Setup SSH Config
          command: |
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh

            # Add Unraid server to known hosts
            ssh-keyscan -H "${PROD_SERVER_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true

            cat > ~/.ssh/config \<<-EOF
            Host unraid-prod
              HostName ${PROD_SERVER_HOST}
              User ${PROD_SERVER_USER}
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
              LogLevel ERROR
            EOF

            chmod 600 ~/.ssh/config

      - run:
          name: Verify SSH Connection
          command: |
            echo "Testing SSH connection to Unraid server..."
            ssh unraid-prod "echo 'SSH connection successful'"