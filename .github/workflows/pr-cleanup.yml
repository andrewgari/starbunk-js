name: PR Cleanup

on:
    pull_request:
        types: [closed]

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: Login to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract branch name
              shell: bash
              run: echo "BRANCH_NAME=$(echo ${GITHUB_HEAD_REF} | tr '/' '-' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

            - name: Delete PR images
              run: |
                  gh api \
                    --method DELETE \
                    "/user/packages/container/starbunk-js/versions/$(echo pr-${{ github.event.pull_request.number }} | sha256sum | cut -d' ' -f1)" \
                    || true
