version: 2.1

setup: true

executors:
  node20:
    docker:
      - image: cimg/node:20.16
    resource_class: medium

jobs:
  detect_and_continue:
    executor: node20
    steps:
      - checkout
      - run:
          name: Fetch main for diff
          command: git fetch origin main || true
      - run:
          name: Detect changed paths
          command: .circleci/scripts/detect_changes.sh
      - run:
          name: Generate dynamic config
          command: |
            if [ -n "${CIRCLE_TAG:-}" ]; then
              echo "ðŸ·ï¸ Detected git tag: $CIRCLE_TAG - loading deployment workflow"
              cp .circleci/workflows/main-merge.yml .circleci/generated_config.yml
            else
              .circleci/scripts/generate_config.py > .circleci/generated_config.yml
            fi
      - run:
          name: Build continuation payload
          command: >
            python3 -c "import json, os; from pathlib import Path;
            Path('/tmp/continuation_payload.json').write_text(json.dumps({'continuation-key': os.environ['CIRCLE_CONTINUATION_KEY'],
            'configuration': Path('.circleci/generated_config.yml').read_text(),
            'parameters': {}}))"
      - run:
          name: Continue pipeline
          command: |
            RESP_FILE=/tmp/continuation_resp.json
            HTTP_CODE=$(curl -sS -w "\n%{http_code}" -o "$RESP_FILE" -X POST -H 'Content-Type: application/json' -d @/tmp/continuation_payload.json "https://circleci.com/api/v2/pipeline/continue")
            STATUS=$(echo "$HTTP_CODE" | tail -n1)
            BODY=$(cat "$RESP_FILE")
            echo "Continuation HTTP status: $STATUS"
            echo "Continuation response: $BODY"
            PIPELINE_ID=$(python3 -c "import json, sys; print(json.load(sys.stdin).get('pipeline_id', ''))" < "$RESP_FILE")
            if [ "$STATUS" != "200" ]; then echo "Continuation failed with HTTP $STATUS" >&2; exit 1; fi
            if [ -z "$PIPELINE_ID" ]; then echo "Continuation did not return pipeline_id" >&2; exit 1; fi
            echo "Continuation spawned pipeline_id: $PIPELINE_ID"

workflows:
  setup:
    jobs:
      - detect_and_continue:
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
