name: 'Setup Node.js with Intelligent Caching'
description: 'Sets up Node.js with optimized caching for monorepo dependencies and builds'

inputs:
  node-version:
    description: 'Node.js version to use'
    required: true
    default: '20'

  cache-dependency-path:
    description: 'Additional dependency paths to include in cache key'
    required: false
    default: '**/package-lock.json'

  install-dependencies:
    description: 'Whether to install dependencies automatically'
    required: false
    default: 'true'

  build-shared:
    description: 'Whether to build the shared package automatically'
    required: false
    default: 'true'

outputs:
  cache-hit:
    description: 'Whether dependencies were loaded from cache'
    value: ${{ steps.cache.outputs.cache-hit }}

  node-version:
    description: 'Actual Node.js version installed'
    value: ${{ steps.setup-node.outputs.node-version }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      id: setup-node
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm'

    - name: Generate cache key
      id: cache-key
      shell: bash
      run: |
        # Create comprehensive cache key including:
        # - Lock files hash
        # - Shared package source files hash (for build cache)
        # - Node version
        # - OS for platform-specific dependencies

        LOCKFILE_HASH=$(find . -name "package-lock.json" -exec cat {} \; | sha256sum | cut -d' ' -f1)

        # Include shared package source in cache key since it affects builds
        SHARED_HASH=""
        if [ -d "packages/shared/src" ]; then
          SHARED_HASH=$(find packages/shared/src -name "*.ts" -o -name "*.js" -exec cat {} \; 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "no-shared")
        fi

        # Include shared package config files
        SHARED_CONFIG_HASH=""
        if [ -f "packages/shared/package.json" ]; then
          SHARED_CONFIG_HASH=$(cat packages/shared/package.json packages/shared/tsconfig.json 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "no-config")
        fi

        CACHE_KEY="node-${{ inputs.node-version }}-${{ runner.os }}-deps-${LOCKFILE_HASH}-shared-${SHARED_HASH}-config-${SHARED_CONFIG_HASH}"

        echo "cache-key=$CACHE_KEY" >> $GITHUB_OUTPUT
        echo "ğŸ”‘ Cache key: $CACHE_KEY"

    - name: Cache dependencies and builds
      id: cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
          packages/shared/node_modules
          apps/bunkbot/node_modules
          apps/djcova/node_modules
          apps/starbunk-dnd/node_modules
          apps/covabot/node_modules
          packages/shared/dist
          packages/shared/lib
        key: ${{ steps.cache-key.outputs.cache-key }}
        restore-keys: |
          node-${{ inputs.node-version }}-${{ runner.os }}-deps-

    - name: Install dependencies
      if: inputs.install-dependencies == 'true'
      shell: bash
      run: |
        # Check if we got an exact cache match or a partial restore-key match
        CACHE_KEY="${{ steps.cache-key.outputs.cache-key }}"
        RESTORED_KEY="${{ steps.cache.outputs.cache-matched-key }}"

        if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ] && [ "$CACHE_KEY" = "$RESTORED_KEY" ]; then
          echo "ğŸ“¦ Exact cache match - verifying dependencies..."

          # Verify critical dependencies exist, reinstall if missing
          NEEDS_INSTALL=false

          # Check if @types/node exists in shared package (common failure point)
          if [ ! -d "packages/shared/node_modules/@types/node" ]; then
            echo "âš ï¸  Missing @types/node in shared package - cache may be incomplete"
            NEEDS_INSTALL=true
          fi

          # Check if root node_modules exists
          if [ ! -d "node_modules" ]; then
            echo "âš ï¸  Missing root node_modules - cache may be incomplete"
            NEEDS_INSTALL=true
          fi

          if [ "$NEEDS_INSTALL" = "false" ]; then
            echo "âœ… Cache verified - all dependencies present"
            exit 0
          else
            echo "ğŸ”„ Reinstalling dependencies due to incomplete cache..."
          fi
        elif [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
          echo "ğŸ“¦ Partial cache match (restore-key) - reinstalling to ensure correctness..."
          echo "   Expected key: $CACHE_KEY"
          echo "   Restored key: $RESTORED_KEY"
        else
          echo "ğŸ“¦ No cache hit - installing dependencies in parallel..."
        fi

        # This is an npm workspaces monorepo, so we only need to install at the root level
        # npm will handle installing all workspace dependencies automatically
        echo "ğŸ“¦ Installing dependencies for all workspaces..."

        # Use --ignore-scripts to prevent prepare scripts from running
        # The prepare script will be run later if needed
        if npm ci --prefer-offline --no-audit --ignore-scripts; then
          echo "âœ… All workspace dependencies installed successfully"
        else
          echo "âŒ Dependency installation failed"
          exit 1
        fi

    - name: Build shared package
      if: inputs.build-shared == 'true' && steps.cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        if [ -d "packages/shared" ] && [ -f "packages/shared/package.json" ]; then
          echo "ğŸ”¨ Building shared package..."
          cd packages/shared

          # Check if build script exists
          if npm run --silent build --dry-run 2>/dev/null; then
            npm run build
            echo "âœ… Shared package built successfully"
          else
            echo "âš ï¸  No build script found for shared package"
          fi
        else
          echo "âš ï¸  No shared package found to build"
        fi

    - name: Verify installation
      shell: bash
      run: |
        echo "ğŸ” Verifying Node.js setup..."
        echo "Node.js version: $(node --version)"
        echo "NPM version: $(npm --version)"

        # Check if key dependencies are available
        if [ -f "package.json" ]; then
          echo "ğŸ“‹ Root package.json found"
        fi

        # Check container setups
        for container in shared bunkbot djcova starbunk-dnd covabot; do
          if [ -d "apps/$container" ]; then
            if [ -d "apps/$container/node_modules" ]; then
              echo "âœ… $container: Dependencies installed"
            else
              echo "âš ï¸  $container: No node_modules found"
            fi

            if [ "$container" = "shared" ] && [ -d "packages/shared/dist" ]; then
              echo "âœ… shared: Build artifacts found"
            fi
          fi
        done

        echo "ğŸ‰ Node.js setup verification complete"

    - name: Cache statistics
      shell: bash
      run: |
        if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
          echo "ğŸ“ˆ Cache hit! Dependencies and builds restored from cache"
          echo "âš¡ Estimated time saved: ~3-5 minutes"
        else
          echo "ğŸ’¾ Cache miss - dependencies installed and cached for next run"
          echo "ğŸ”„ Next run will be significantly faster"
        fi
