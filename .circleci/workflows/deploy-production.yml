version: 2.1

# Production Deployment Workflow
# Triggers on GitHub release publication
# Deploys to Unraid server via SSH

executors:
  deployer:
    machine:
      image: ubuntu-2404:current
    resource_class: medium

commands:
  notify_discord:
    description: "Send deployment notification to Discord"
    parameters:
      status:
        type: string
        description: "Deployment status: started, success, failed"
      version:
        type: string
        default: "${CIRCLE_BRANCH}"
      message:
        type: string
        default: ""
    steps:
      - run:
          name: Send Discord Notification
          when: always
          command: |
            if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
              echo "WARNING: DISCORD_WEBHOOK_URL not configured - skipping notification"
              exit 0
            fi

            STATUS="<< parameters.status >>"
            VERSION="<< parameters.version >>"
            MESSAGE="<< parameters.message >>"

            case "$STATUS" in
              started)
                COLOR=3447003  # Blue
                EMOJI=":rocket:"
                TITLE="Deployment Started"
                ;;
              success)
                COLOR=3066993  # Green
                EMOJI=":white_check_mark:"
                TITLE="Deployment Successful"
                ;;
              failed)
                COLOR=15158332  # Red
                EMOJI=":x:"
                TITLE="Deployment Failed"
                ;;
              *)
                COLOR=10181046  # Purple
                EMOJI=":information_source:"
                TITLE="Deployment Update"
                ;;
            esac

            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            BUILD_URL="https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}"
            
            # Escape MESSAGE for JSON to prevent injection
            MESSAGE_ESCAPED=$(echo "<< parameters.message >>" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/$/\\n/g' | tr -d '\n')

            PAYLOAD=$(cat \<<-EOF
            {
              "embeds": [{
                "title": "${EMOJI} ${TITLE}",
                "description": "${MESSAGE_ESCAPED}",
                "color": ${COLOR},
                "fields": [
                  {
                    "name": "Version/Branch",
                    "value": "\`${VERSION}\`",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "\`${CIRCLE_BRANCH:-N/A}\`",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "\`${CIRCLE_SHA1:0:7}\`",
                    "inline": true
                  },
                  {
                    "name": "Triggered By",
                    "value": "${CIRCLE_USERNAME:-CircleCI}",
                    "inline": true
                  }
                ],
                "timestamp": "${TIMESTAMP}",
                "footer": {
                  "text": "Starbunk Production Deployment"
                },
                "url": "${BUILD_URL}"
              }]
            }
            EOF
            )

            curl -H "Content-Type: application/json" \
                 -d "${PAYLOAD}" \
                 "${DISCORD_WEBHOOK_URL}"

jobs:
  deploy_to_production:
    executor: deployer
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - '${SSH_KEY_FINGERPRINT}'

      - notify_discord:
          status: started
          version: '${CIRCLE_SHA1:0:7}'
          message: 'Deploying Starbunk services to production Unraid server...'

      - run:
          name: Setup SSH Config
          command: |
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh

            # Add Unraid server to known hosts
            ssh-keyscan -H "${PROD_SERVER_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true

            cat > ~/.ssh/config \<<-EOF
            Host unraid-prod
              HostName ${PROD_SERVER_HOST}
              User ${PROD_SERVER_USER}
              LogLevel ERROR
            EOF

            chmod 600 ~/.ssh/config

      - run:
          name: Verify SSH Connection
          command: |
            echo "Testing SSH connection to Unraid server..."
            ssh unraid-prod "echo 'SSH connection successful'"

      - run:
          name: Deploy to Unraid Server
          command: |
            # Read version from VERSION file
            VERSION=$(cat config/VERSION 2>/dev/null || echo "unknown")
            DEPLOY_TAG="main"  # Use :main tag for production deployments

            echo "========================================"
            echo "Deploying version: ${VERSION}"
            echo "Using image tag: ${DEPLOY_TAG}"
            echo "Target: ${PROD_SERVER_HOST}"
            echo "Commit: ${CIRCLE_SHA1:0:7}"
            echo "========================================"

            # Copy deployment script to server
            scp scripts/deployment/deploy.sh unraid-prod:/tmp/starbunk-deploy.sh
            scp scripts/deployment/health-check.sh unraid-prod:/tmp/starbunk-health-check.sh

            # Execute deployment on server
            ssh unraid-prod "bash /tmp/starbunk-deploy.sh '${PROD_DOCKER_COMPOSE_DIR}' '${DEPLOY_TAG}' '${VERSION}'"

      - run:
          name: Verify Deployment Health
          command: |
            echo "========================================"
            echo "Running post-deployment health checks..."
            echo "========================================"

            # Run health check script on server
            ssh unraid-prod "bash /tmp/starbunk-health-check.sh '${PROD_DOCKER_COMPOSE_DIR}'"

      - run:
          name: Cleanup Remote Scripts
          when: always
          command: |
            ssh unraid-prod "rm -f /tmp/starbunk-*.sh" || true

      - run:
          name: Notify Success
          when: on_success
          command: |
            if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
              echo "WARNING: DISCORD_WEBHOOK_URL not configured - skipping notification"
              exit 0
            fi

            VERSION="${CIRCLE_SHA1:0:7}"
            MESSAGE="All services deployed and healthy on production server!"
            COLOR=3066993  # Green
            EMOJI=":white_check_mark:"
            TITLE="Deployment Successful"
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            BUILD_URL="https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}"

            PAYLOAD=$(cat \<<-EOF
            {
              "embeds": [{
                "title": "${EMOJI} ${TITLE}",
                "description": "${MESSAGE}",
                "color": ${COLOR},
                "fields": [
                  {
                    "name": "Version",
                    "value": "\`${VERSION}\`",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "\`${CIRCLE_BRANCH:-N/A}\`",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "\`${CIRCLE_SHA1:0:7}\`",
                    "inline": true
                  },
                  {
                    "name": "Triggered By",
                    "value": "${CIRCLE_USERNAME:-CircleCI}",
                    "inline": true
                  }
                ],
                "timestamp": "${TIMESTAMP}",
                "footer": {
                  "text": "Starbunk Production Deployment"
                },
                "url": "${BUILD_URL}"
              }]
            }
            EOF
            )

            curl -H "Content-Type: application/json" \
                 -d "${PAYLOAD}" \
                 "${DISCORD_WEBHOOK_URL}"

      - run:
          name: Notify Failure
          when: on_fail
          command: |
            if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
              echo "WARNING: DISCORD_WEBHOOK_URL not configured - skipping notification"
              exit 0
            fi

            VERSION="${CIRCLE_SHA1:0:7}"
            MESSAGE="Deployment failed! Check CircleCI logs for details."
            COLOR=15158332  # Red
            EMOJI=":x:"
            TITLE="Deployment Failed"
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            BUILD_URL="https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}"

            PAYLOAD=$(cat \<<-EOF
            {
              "embeds": [{
                "title": "${EMOJI} ${TITLE}",
                "description": "${MESSAGE}",
                "color": ${COLOR},
                "fields": [
                  {
                    "name": "Version",
                    "value": "\`${VERSION}\`",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "\`${CIRCLE_BRANCH:-N/A}\`",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "\`${CIRCLE_SHA1:0:7}\`",
                    "inline": true
                  },
                  {
                    "name": "Triggered By",
                    "value": "${CIRCLE_USERNAME:-CircleCI}",
                    "inline": true
                  }
                ],
                "timestamp": "${TIMESTAMP}",
                "footer": {
                  "text": "Starbunk Production Deployment"
                },
                "url": "${BUILD_URL}"
              }]
            }
            EOF
            )

            curl -H "Content-Type: application/json" \
                 -d "${PAYLOAD}" \
                 "${DISCORD_WEBHOOK_URL}"

workflows:
  # Production deployment triggered on pushes to main branch
  production_deployment:
    jobs:
      - deploy_to_production:
          context:
            - deployment-production
          filters:
            branches:
              only: main
