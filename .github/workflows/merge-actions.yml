name: Merge Actions

on:
    pull_request:
        types: [closed]
        branches: [main]

jobs:
    cleanup:
        if: github.event.pull_request.merged == true
        uses: ./.github/workflows/pr-cleanup.yml

    publish-latest:
        if: github.event.pull_request.merged == true
        needs: cleanup
        uses: ./.github/workflows/docker-publish.yml
        with:
            tag: latest

    publish-sha:
        if: github.event.pull_request.merged == true
        needs: cleanup
        uses: ./.github/workflows/docker-publish.yml
        with:
            tag: ${{ github.sha }}

    summary:
        if: github.event.pull_request.merged == true
        needs: [cleanup, publish-latest, publish-sha]
        runs-on: ubuntu-latest
        steps:
            - name: 📝 Merge Summary
              run: |
                  echo "### 🚀 PR Merged and Actions Completed" >> $GITHUB_STEP_SUMMARY
                  echo "| Action | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
                  echo "| **PR Cleanup** | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Latest Image** | ✅ Published |" >> $GITHUB_STEP_SUMMARY
                  echo "| **SHA Image** | ✅ Published |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Image URL** | 🔗 [View in GitHub Container Registry](https://github.com/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }}) |" >> $GITHUB_STEP_SUMMARY
