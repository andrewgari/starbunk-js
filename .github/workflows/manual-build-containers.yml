name: Manual - Build Containers

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (leave empty to use VERSION file)'
        type: string
        required: false
        default: ''
      containers:
        description: 'Containers to build (comma-separated: bunkbot,djcova,starbunk-dnd,covabot or "all")'
        type: string
        required: false
        default: 'all'

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  REGISTRY_PREFIX: ghcr.io/${{ github.repository_owner }}
  NODE_VERSION: '20'

jobs:
  prepare:
    name: ğŸ” Prepare Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine-version.outputs.version }}
      containers: ${{ steps.determine-containers.outputs.containers }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ“¦ Determine Version
        id: determine-version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            VERSION="${{ github.event.inputs.version_override }}"
            echo "ğŸ“¦ Using override version: $VERSION"
          else
            if [ ! -f "VERSION" ]; then
              echo "âŒ ERROR: VERSION file not found"
              exit 1
            fi
            VERSION=$(tr -d '[:space:]' < VERSION)
            echo "ğŸ“¦ Using VERSION file: $VERSION"
          fi

          # Validate version format (SemVer: X.Y.Z with optional pre-release and build metadata)
          if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'; then
            echo "âŒ ERROR: Invalid version format '$VERSION' (expected X.Y.Z, optionally with pre-release/build metadata)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ¯ Determine Containers
        id: determine-containers
        run: |
          INPUT="${{ github.event.inputs.containers }}"
          VALID_CONTAINERS=("bunkbot" "djcova" "starbunk-dnd" "covabot")

          if [ "$INPUT" = "all" ] || [ -z "$INPUT" ]; then
            CONTAINERS='["bunkbot", "djcova", "starbunk-dnd", "covabot"]'
            echo "ğŸš€ Building all containers"
          else
            # Convert comma-separated list to JSON array with validation
            IFS=',' read -ra CONTAINER_ARRAY <<< "$INPUT"
            INVALID_CONTAINERS=()
            VALID_SELECTED=()
            
            # First pass: validate all container names
            for container_input in "${CONTAINER_ARRAY[@]}"; do
              container=$(echo "$container_input" | xargs)
              # Skip empty container names (e.g., from trailing or consecutive commas)
              if [ -z "$container" ]; then
                continue
              fi
              
              # Validate container name
              valid=false
              for valid_container in "${VALID_CONTAINERS[@]}"; do
                if [ "$container" = "$valid_container" ]; then
                  valid=true
                  break
                fi
              done
              
              if [ "$valid" = false ]; then
                INVALID_CONTAINERS+=("$container")
              else
                VALID_SELECTED+=("$container")
              fi
            done
            
            # Report invalid containers and fail if any found
            if [ ${#INVALID_CONTAINERS[@]} -gt 0 ]; then
              INVALID_LIST=$(IFS=','; echo "${INVALID_CONTAINERS[*]}")
              VALID_LIST=$(IFS=','; echo "${VALID_CONTAINERS[*]}")
              echo "âŒ ERROR: Invalid container name(s): $INVALID_LIST"
              echo "âœ… Valid options are: $VALID_LIST"
              exit 1
            fi
            
            # Build JSON array from valid containers
            CONTAINERS="["
            for i in "${!VALID_SELECTED[@]}"; do
              if [ $i -gt 0 ]; then
                CONTAINERS+=","
              fi
              CONTAINERS+="\"${VALID_SELECTED[$i]}\""
            done
            CONTAINERS+="]"
            
            echo "ğŸš€ Building selected containers: $CONTAINERS"
          fi

          echo "containers=$CONTAINERS" >> $GITHUB_OUTPUT

  build-containers:
    name: ğŸ—ï¸ Build ${{ matrix.container }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.prepare.outputs.containers) }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Extract Container Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_PREFIX }}/${{ matrix.container }}
          tags: |
            type=raw,value=latest
            type=raw,value=v${{ needs.prepare.outputs.version }}
            type=raw,value=${{ needs.prepare.outputs.version }}
          labels: |
            org.opencontainers.image.title=${{ matrix.container }}
            org.opencontainers.image.description=Starbunk Discord Bot - ${{ matrix.container }} container
            org.opencontainers.image.vendor=Starbunk
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            build.manual=true
            build.timestamp=${{ github.run_id }}

      - name: ğŸ—ï¸ Build and Push Container Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.container }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: |
            type=gha,scope=${{ matrix.container }}
            type=registry,ref=${{ env.REGISTRY_PREFIX }}/${{ matrix.container }}:latest
          cache-to: |
            type=gha,mode=max,scope=${{ matrix.container }}
          provenance: false
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            BUILD_DATE=${{ github.run_id }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ needs.prepare.outputs.version }}
            NODE_ENV=production
            LOG_LEVEL=info

      - name: âœ… Verify Image
        run: |
          echo "âœ… Successfully built and pushed ${{ matrix.container }}"
          echo "ğŸ“¦ Image: ${{ env.REGISTRY_PREFIX }}/${{ matrix.container }}:latest"
          echo "ğŸ·ï¸ Version: ${{ needs.prepare.outputs.version }}"

  tag-commit:
    name: ğŸ·ï¸ Tag Git Commit
    runs-on: ubuntu-latest
    needs: [prepare, build-containers]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ğŸ·ï¸ Create and Push Git Tags
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create tags
          echo "ğŸ·ï¸ Creating git tag v$VERSION for commit $(git rev-parse HEAD)"

          # Delete tag if it exists (for re-runs with same version)
          git tag -d "v$VERSION" 2>/dev/null || true
          git push origin ":refs/tags/v$VERSION" 2>/dev/null || true

          # Create new tag
          git tag -a "v$VERSION" -m "Release v$VERSION - Manual build from workflow"

          # Push tag
          git push origin "v$VERSION"

          echo "âœ… Successfully tagged commit $(git rev-parse HEAD) with v$VERSION"

  summary:
    name: ğŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [prepare, build-containers, tag-commit]
    if: always()
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          CONTAINERS='${{ needs.prepare.outputs.containers }}'
          BUILD_RESULT="${{ needs.build-containers.result }}"
          TAG_RESULT="${{ needs.tag-commit.result }}"

          echo "## ğŸ“‹ Manual Container Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Version: \`v$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Pre-generate container tables to avoid duplication
          # Use mapfile to reliably capture output
          # Validate JSON before parsing
          if [ -n "$CONTAINERS" ] && echo "$CONTAINERS" | jq empty >/dev/null 2>&1; then
            mapfile -t container_array < <(echo "$CONTAINERS" | jq -r '.[]')
          else
            container_array=()
          fi
          
          # Generate container table
          generate_container_table() {
            echo "| Container | Tags |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------|" >> $GITHUB_STEP_SUMMARY
            for container in "${container_array[@]}"; do
              echo "| $container | \`latest\`, \`v$VERSION\`, \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
            done
          }
          
          # Generate pull commands
          generate_pull_commands() {
            for container in "${container_array[@]}"; do
              echo "docker pull ghcr.io/${{ github.repository_owner }}/$container:latest" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ghcr.io/${{ github.repository_owner }}/$container:v$VERSION" >> $GITHUB_STEP_SUMMARY
            done
          }
          
          # Generate container list
          generate_container_list() {
            for container in "${container_array[@]}"; do
              echo "- $container" >> $GITHUB_STEP_SUMMARY
            done
          }

          # Determine overall status and display appropriate message
          if [[ "$BUILD_RESULT" == "success" && "$TAG_RESULT" == "success" ]]; then
            echo "### âœ… Build Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ All containers built and tagged successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ·ï¸ Git Tag: \`v$VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ³ Built Containers" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            generate_container_table
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”§ Pull Commands" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            generate_pull_commands
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          elif [[ "$BUILD_RESULT" == "success" ]]; then
            # Build succeeded but tagging did not complete successfully
            echo "### âš ï¸ Build Status: Partial Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Provide specific messaging based on tag result
            case "$TAG_RESULT" in
              "failure")
                echo "ğŸ³ Containers built successfully, but git tagging failed." >> $GITHUB_STEP_SUMMARY
                ;;
              "cancelled")
                echo "ğŸ³ Containers built successfully, but git tagging was cancelled." >> $GITHUB_STEP_SUMMARY
                ;;
              "skipped")
                echo "ğŸ³ Containers built successfully, but git tagging was skipped." >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "ğŸ³ Containers built successfully, but git tagging did not complete successfully (status: $TAG_RESULT)." >> $GITHUB_STEP_SUMMARY
                ;;
            esac
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ³ Built Containers" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            generate_container_table
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Note:** Git tag \`v$VERSION\` was not created. You may need to tag manually." >> $GITHUB_STEP_SUMMARY
          else
            # Build did not complete successfully
            echo "### âŒ Build Status: Not Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Provide detailed status information
            echo "**Job Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Build: \`$BUILD_RESULT\`" >> $GITHUB_STEP_SUMMARY
            echo "- Tag: \`$TAG_RESULT\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Provide specific messaging based on build result
            case "$BUILD_RESULT" in
              "failure")
                echo "âŒ Container builds failed." >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "ğŸ” **Action Required:** Check the build-containers job logs for details" >> $GITHUB_STEP_SUMMARY
                ;;
              "cancelled")
                echo "ğŸš« Container builds were cancelled." >> $GITHUB_STEP_SUMMARY
                ;;
              "skipped")
                echo "â­ï¸ Container builds were skipped." >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "âš ï¸ Workflow did not complete successfully." >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "ğŸ” **Action Required:** Check the workflow logs for details" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“‹ Attempted Containers" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            generate_container_list
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”„ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the error logs in the failed/cancelled jobs" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix any issues in the Dockerfiles or build configuration" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run the workflow" >> $GITHUB_STEP_SUMMARY
          fi

