version: 2.1

# App-specific jobs for covabot
# Shared executors and commands are defined in shared-config.yml

jobs:
  covabot_build:
    executor: node20
    steps:
      - checkout
      - setup_npm_cache
      - run:
          name: Build Covabot
          command: npm run build:covabot
      - persist_build_artifacts

  covabot_test:
    executor: node20
    steps:
      - checkout
      - setup_npm_cache
      - run:
          name: Build shared package
          command: npm run build:shared
      - run:
          name: Rebuild native dependencies
          command: npm rebuild better-sqlite3
      - run:
          name: Test Covabot
          command: npm run test:covabot

  covabot_docker_build:
    executor: node20
    environment:
      APP: covabot
      DOCKERFILE: "./src/covabot/Dockerfile.ci"
    steps:
      - checkout
      - attach_build_artifacts
      - run:
          name: Rebuild artifacts if missing
          command: |
            MISSING=false
            for app in shared bunkbot bluebot covabot djcova; do
              if [ ! -d "src/$app/dist" ]; then
                MISSING=true
                echo "⚠ Missing src/$app/dist"
              fi
            done

            if [ "$MISSING" = true ]; then
              echo "Rebuilding missing artifacts..."
              npm ci
              npm run build
              echo "Rebuild complete"
            else
              echo "All artifacts present"
            fi
      - setup_docker_cli
      - setup_remote_docker
      - run:
          name: Build Docker Image
          command: |
            set -e

            # Compute content hash for caching
            HASH=$(git rev-parse HEAD:src/${APP} 2>/dev/null || echo "no-hash")
            SHARED_HASH=$(git rev-parse HEAD:src/shared 2>/dev/null || echo "no-shared")
            DEPS_HASH=$(sha256sum package-lock.json | cut -d' ' -f1 | head -c 12)
            CONTENT_HASH="${HASH:0:12}-${SHARED_HASH:0:12}-${DEPS_HASH}"

            # Login to GHCR (credentials from CircleCI context)
            if [ -n "${GHCR_TOKEN:-}" ]; then
              echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin || true
            fi

            # Pull cache image if available
            docker pull ghcr.io/andrewgari/starbunk-${APP}:cache 2>/dev/null || true

            # Build with cache
            docker build \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              --cache-from ghcr.io/andrewgari/starbunk-${APP}:cache \
              -f $DOCKERFILE \
              -t ghcr.io/andrewgari/starbunk-${APP}:${CIRCLE_SHA1:0:7} \
              -t ghcr.io/andrewgari/starbunk-${APP}:latest \
              .

  covabot_docker_health_check:
    executor: docker
    environment:
      APP: covabot
    steps:
      - checkout
      - setup_docker_cli
      - setup_remote_docker
      - run:
          name: Health Check
          command: |
            ls -la .circleci/scripts/ || echo "Directory not found"
            if [ -f .circleci/scripts/container_health_check.sh ]; then
              chmod +x .circleci/scripts/container_health_check.sh

              # For PR validation, skip health check since image isn't pushed to registry
              echo "⊘ Skipping health check - image not available in registry for PR validation"
              echo "Note: Health checks run on main merge after image is pushed to GHCR"
            else
              echo "ERROR: container_health_check.sh not found"
              pwd
              ls -la
              exit 1
            fi

workflows:
  covabot-checks:
    jobs:
      - covabot_build
      - covabot_test:
          requires:
            - covabot_build
      - covabot_docker_build:
          requires:
            - covabot_build
            - covabot_test
      - covabot_docker_health_check:
          requires:
            - covabot_docker_build
