name: Merge Actions

on:
    pull_request:
        types: [closed]
        branches: [main]

jobs:
    publish:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4

            - name: 🔐 Login to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: 🗑️ Delete PR Image
              id: delete_image
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;
                      const packageName = `${owner}/${repo}`.toLowerCase();
                      const tag = `pr-${prNumber}`;

                      try {
                        await github.rest.packages.deletePackageVersionForOrg({
                          package_type: 'container',
                          package_name: packageName,
                          org: owner,
                          version_id: tag
                        });
                        console.log(`Deleted container image with tag: ${tag}`);
                        return { success: true, tag: tag };
                      } catch (error) {
                        console.log(`Failed to delete image or image not found: ${error.message}`);
                        return { success: false, error: error.message };
                      }

            - name: 🏗️ Build and Push
              id: docker_build
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: |
                      ghcr.io/${{ github.repository }}:latest
                      ghcr.io/${{ github.repository }}:${{ github.sha }}

            - name: 📝 Merge Summary
              run: |
                  echo "### 🚀 PR Merged and Images Published" >> $GITHUB_STEP_SUMMARY
                  echo "| Action | Status | Details |" >> $GITHUB_STEP_SUMMARY
                  echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
                  echo "| **PR Cleanup** | ${{ fromJSON(steps.delete_image.outputs.result).success && '✅ Success' || '⚠️ Warning' }} | PR #${{ github.event.pull_request.number }} image ${{ fromJSON(steps.delete_image.outputs.result).success && 'deleted' || 'not found or failed to delete' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **New Images** | ✅ Published | ghcr.io/${{ github.repository }}:latest<br>ghcr.io/${{ github.repository }}:${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Digest** | 📝 | ${{ steps.docker_build.outputs.digest }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Image URL** | 🔗 | [View in GitHub Container Registry](https://github.com/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }}) |" >> $GITHUB_STEP_SUMMARY
