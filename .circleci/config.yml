version: 2.1

setup: true

executors:
  node20:
    docker:
      - image: cimg/node:20.16
    resource_class: medium

jobs:
  detect_and_continue:
    executor: node20
    steps:
      - checkout
      - run:
          name: Fetch main for diff
          command: git fetch origin main || true
      - run:
          name: Detect changed paths
          command: .circleci/scripts/detect_changes.sh
      - run:
          name: Generate dynamic config
          command: |
            # Check if this is a tag push (deployment trigger)
            if [ -n "${CIRCLE_TAG:-}" ]; then
              echo "ðŸ·ï¸ Detected git tag: $CIRCLE_TAG - loading deployment workflow"
              cp .circleci/workflows/main-merge.yml .circleci/generated_config.yml
            else
              # For PRs and other branches, generate based on detected changes
              .circleci/scripts/generate_config.py > .circleci/generated_config.yml
            fi
- run:
    name: Continue pipeline (log response)
    command: |
      # Build payload without printing the continuation key
      CONFIG_JSON=$(python - <<'PY'
      import json
      import os
      from pathlib import Path

      payload = {
          "continuation-key": os.environ["CIRCLE_CONTINUATION_KEY"],
          "configuration": Path(".circleci/generated_config.yml").read_text(),
          "parameters": {},
      }

      print(json.dumps(payload))
      PY
      )

            # Send continuation request and capture status + body
            RESP_FILE=/tmp/continuation_resp.json
            HTTP_CODE=$(echo "$CONFIG_JSON" | curl -sS -w "\n%{http_code}" -o "$RESP_FILE" \
              -X POST \
              -H 'Content-Type: application/json' \
              "https://circleci.com/api/v2/pipeline/continue")

            # Separate body and status code
            STATUS=$(echo "$HTTP_CODE" | tail -n1)
            BODY=$(cat "$RESP_FILE")

            echo "Continuation HTTP status: $STATUS"
            echo "Continuation response: $BODY"

# Fail fast if the API did not return a pipeline_id
PIPELINE_ID=$(python - <<'PY'
import json
import sys

try:
    body = json.load(sys.stdin)
    print(body.get("pipeline_id", ""))
except Exception:
    print("")
PY
<<< "$BODY")

            if [ "$STATUS" != "200" ]; then
              echo "Continuation failed with HTTP $STATUS" >&2
              exit 1
            fi

            if [ -z "$PIPELINE_ID" ]; then
              echo "Continuation did not return pipeline_id; failing setup so we can see logs." >&2
              exit 1
            fi

            echo "Continuation spawned pipeline_id: $PIPELINE_ID"

workflows:
  setup:
    jobs:
      - detect_and_continue:
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/

