version: '3.8'

# Production deployment using pre-built images from GitHub Container Registry (GHCR)
# Images are built by CI/CD pipeline and tagged as 'prod' for production releases
# For local development with source builds, see src/{service}/docker-compose.dev.yml

services:
  # BunkBot - Next generation YAML-based reply bot system
  bunkbot:
    image: ghcr.io/andrewgari/bunkbot:prod
    container_name: starbunk-bunkbot
    restart: unless-stopped
    environment:
      # Core Discord Configuration
      - DISCORD_TOKEN=${BUNKBOT_TOKEN}
      - CLIENT_ID=${BUNKBOT_CLIENT_ID:-}
      - GUILD_ID=${GUILD_ID}

      # Storage Configuration
      - BUNKBOT_BOTS_DIR=/app/config

      # Observability Configuration
      - SERVICE_NAME=${BUNKBOT_SERVICE_NAME:-bunkbot}
      - HEALTH_PORT=${HEALTH_PORT:-3000}
      - METRICS_PORT=${METRICS_PORT:-3000}
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - ENABLE_STRUCTURED_LOGGING=${ENABLE_STRUCTURED_LOGGING:-true}
      - OTEL_COLLECTOR_HOST=${OTEL_COLLECTOR_HOST:-starbunk-otel-collector}
      - OTEL_COLLECTOR_HTTP_PORT=${OTEL_COLLECTOR_HTTP_PORT:-4318}

      # Environment & Logging
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Debug/Testing Configuration
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - TESTING_SERVER_IDS=${TESTING_SERVER_IDS:-}
      - TESTING_CHANNEL_IDS=${TESTING_CHANNEL_IDS:-}
    volumes:
      - ${HOST_WORKDIR}/config/bunkbot:/app/config:ro
    networks:
      - starbunk-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - com.starbunk.service=bunkbot
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # DJCova - Music service
  djcova:
    image: ghcr.io/andrewgari/djcova:prod
    container_name: starbunk-djcova
    restart: unless-stopped
    environment:
      # Node/Runtime Configuration
      - NODE_ENV=production

      # Core Discord Configuration
      - DISCORD_TOKEN=${DJCOVA_TOKEN:-${STARBUNK_TOKEN}}
      - CLIENT_ID=${DJCOVA_CLIENT_ID}
      - GUILD_ID=${GUILD_ID}

      # Observability Configuration
      - SERVICE_NAME=${DJCOVA_SERVICE_NAME:-djcova}
      - HEALTH_PORT=${HEALTH_PORT:-3000}
      - METRICS_PORT=${METRICS_PORT:-3000}
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - ENABLE_STRUCTURED_LOGGING=${ENABLE_STRUCTURED_LOGGING:-true}
      - OTEL_COLLECTOR_HOST=${OTEL_COLLECTOR_HOST:-starbunk-otel-collector}
      - OTEL_COLLECTOR_HTTP_PORT=${OTEL_COLLECTOR_HTTP_PORT:-4318}

      # Environment & Logging
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Debug/Testing Configuration
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - TESTING_SERVER_IDS=${TESTING_SERVER_IDS:-}
      - TESTING_CHANNEL_IDS=${TESTING_CHANNEL_IDS:-}
    volumes:
      # Configuration directory (read-only)
      - ${HOST_WORKDIR}/config/djcova:/app/config:ro
      # Optional: Data directory path (default: ./data)
      - ${HOST_WORKDIR}/data/djcova:/data
    networks:
      - starbunk-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - com.starbunk.service=djcova
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # CovaBot - AI personality bot (Cognitive Simulacrum)
  covabot:
    image: ghcr.io/andrewgari/covabot:prod
    container_name: starbunk-covabot
    restart: unless-stopped
    environment:
      # Node/Runtime Configuration
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=768

      # Core Discord Configuration
      - DISCORD_TOKEN=${COVABOT_TOKEN:-${STARBUNK_TOKEN}}

      # AI/LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_DEFAULT_MODEL=${OPENAI_DEFAULT_MODEL:-gpt-4o-mini}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_DEFAULT_MODEL=${GEMINI_DEFAULT_MODEL:-gemini-pro}
      - OLLAMA_API_URL=${OLLAMA_API_URL:-}
      - OLLAMA_DEFAULT_MODEL=${OLLAMA_DEFAULT_MODEL:-mistral:latest}
      - OLLAMA_AUTO_PULL_MODELS=${OLLAMA_AUTO_PULL_MODELS:-true}
      - OLLAMA_PULL_ON_STARTUP=${OLLAMA_PULL_ON_STARTUP:-true}
      - OLLAMA_PULL_TIMEOUT_MS=${OLLAMA_PULL_TIMEOUT_MS:-1200000}

      # External Services - Redis (Social Battery)
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}

      # External Services - Qdrant (Saliency/Interest Matching)
      - QDRANT_URL=${QDRANT_URL:-http://host.docker.internal:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}

      # Storage Configuration
      - COVABOT_DATA_DIR=/app/data
      - COVABOT_API_KEY=${COVABOT_API_KEY:-}
      - COVABOT_PERSONALITIES_PATH=${COVABOT_PERSONALITIES_PATH:-}
      - COVABOT_DATABASE_PATH=${COVABOT_DATABASE_PATH:-}

      # Observability Configuration
      - SERVICE_NAME=${COVABOT_SERVICE_NAME:-covabot}
      - HEALTH_PORT=3000
      - METRICS_PORT=${METRICS_PORT:-3000}
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - ENABLE_STRUCTURED_LOGGING=${ENABLE_STRUCTURED_LOGGING:-true}
      - OTEL_COLLECTOR_HOST=${OTEL_COLLECTOR_HOST:-starbunk-otel-collector}
      - OTEL_COLLECTOR_HTTP_PORT=${OTEL_COLLECTOR_HTTP_PORT:-4318}

      # Environment & Logging
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Debug/Testing Configuration
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - COVA_USER_ID=${COVA_USER_ID:-}
      - TESTING_SERVER_IDS=${TESTING_SERVER_IDS:-}
      - TESTING_CHANNEL_IDS=${TESTING_CHANNEL_IDS:-}
    volumes:
      - ${HOST_WORKDIR}/config/covabot:/app/config:ro
      - ${HOST_WORKDIR}/data/covabot:/app/data
    ports:
      # Optional: Web interface port (default: 7080)
      - "${COVABOT_WEB_PORT:-7080}:7080"
      # No metrics port exposed - all observability via OTEL collector
    networks:
      - starbunk-network
    extra_hosts:
      # Required for host.docker.internal to work on Linux
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - com.starbunk.service=covabot
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # BlueBot - Blue detection and response bot
  bluebot:
    image: ghcr.io/andrewgari/bluebot:prod
    container_name: starbunk-bluebot
    restart: unless-stopped
    environment:
      # Node/Runtime Configuration
      - NODE_ENV=production

      # Core Discord Configuration
      - DISCORD_TOKEN=${BLUEBOT_TOKEN:-${STARBUNK_TOKEN}}

      # Observability Configuration
      - SERVICE_NAME=${BLUEBOT_SERVICE_NAME:-bluebot}
      - HEALTH_PORT=3000
      - METRICS_PORT=${METRICS_PORT:-3000}
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - ENABLE_STRUCTURED_LOGGING=${ENABLE_STRUCTURED_LOGGING:-true}
      - OTEL_COLLECTOR_HOST=${OTEL_COLLECTOR_HOST:-starbunk-otel-collector}
      - OTEL_COLLECTOR_HTTP_PORT=${OTEL_COLLECTOR_HTTP_PORT:-4318}

      # Environment & Logging
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Debug/Testing Configuration
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - TESTING_SERVER_IDS=${TESTING_SERVER_IDS:-}
      - TESTING_CHANNEL_IDS=${TESTING_CHANNEL_IDS:-}
    volumes:
      # Configuration directory (read-only)
      - ${HOST_WORKDIR}/config/bluebot:/app/config:ro
      - ${HOST_WORKDIR}/data/bluebot:/app/data
    networks:
      - starbunk-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - com.starbunk.service=bluebot
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # OpenTelemetry Collector - Unified telemetry pipeline
  starbunk-otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: starbunk-otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yml"]
    volumes:
      - ${HOST_WORKDIR}/config/otel-collector-config.yml:/etc/otel-collector-config.yml:ro
    # OTLP collector exposed to host for external access
    ports:
      - "14317:4317"   # OTLP gRPC receiver (for bot services and host)
      - "14318:4318"   # OTLP HTTP receiver (for bot services and host)
    expose:
      - "8888"        # Prometheus metrics (internal only)
      - "8889"        # Prometheus exporter (internal only)
    environment:
      # Environment & Logging
      - ENVIRONMENT=${ENVIRONMENT:-production}
    networks:
      - starbunk-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - com.starbunk.service=otel-collector
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=8888
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

# Note: Using host path mounts for Unraid compatibility
# Data persists in ${UNRAID_APPDATA_PATH:-./data}/ directory structure
# Default fallback to ./data/ for non-Unraid environments

# Custom network for service communication
networks:
  starbunk-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/16
