version: "3.8"

services:
  # BunkBot - Next generation YAML-based reply bot system
  bunkbot:
    image: ghcr.io/andrewgari/bunkbot:prod
    container_name: starbunk-bunkbot
    restart: unless-stopped
    # Use absolute path so Watchtower can find tokens during auto-updates
    env_file:
      - /mnt/user/appdata/dockge/stacks/starbunk-js/.env
    environment:
      - DISCORD_TOKEN=${BUNKBOT_TOKEN}
      - GUILD_ID=${GUILD_ID}
      - BUNKBOT_BOTS_DIR=/app/config
      - METRICS_PORT=${METRICS_PORT:-3000}
    volumes:
      # Corrected to point to the actual folder in your stacks directory
      - /mnt/user/appdata/dockge/stacks/starbunk-js/config/bunkbot:/app/config:ro
    ports:
      - ${BUNKBOT_METRICS_PORT:-9301}:3000
    networks:
      - starbunk-net
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    labels:
      - com.starbunk.service=bunkbot
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
  # DJCova - Music service
  djcova:
    image: ghcr.io/andrewgari/djcova:prod
    container_name: starbunk-djcova
    restart: unless-stopped
    env_file:
      - /mnt/user/appdata/dockge/stacks/starbunk-js/.env
    environment:
      - NODE_ENV=production
      - DISCORD_TOKEN=${DJCOVA_TOKEN:-${STARBUNK_TOKEN}}
      - CLIENT_ID=${DJCOVA_CLIENT_ID}
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - HEALTH_PORT=${HEALTH_PORT:-3000}
    volumes:
      - /mnt/user/appdata/dockge/stacks/starbunk-js/config/djcova:/app/config:ro
      - /mnt/user/appdata/dockge/stacks/starbunk-js/data/djcova/cache:/app/cache
      - /mnt/user/appdata/dockge/stacks/starbunk-js/data/djcova/temp:/tmp
    ports:
      - ${DJCOVA_METRICS_PORT:-9304}:3000
    networks:
      - starbunk-net
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    labels:
      - com.starbunk.service=djcova
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
  # CovaBot - AI personality bot
  covabot:
    image: ghcr.io/andrewgari/covabot:prod
    container_name: starbunk-covabot
    restart: unless-stopped
    env_file:
      - /mnt/user/appdata/dockge/stacks/starbunk-js/.env
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=768
      - DISCORD_TOKEN=${COVABOT_TOKEN:-${STARBUNK_TOKEN}}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OLLAMA_API_URL=${OLLAMA_API_URL:-}
      - COVABOT_DATA_DIR=/app/data
      - HEALTH_PORT=3000
    volumes:
      - /mnt/user/appdata/dockge/stacks/starbunk-js/config/covabot:/app/config:ro
      - /mnt/user/appdata/dockge/stacks/starbunk-js/data/config/covabot:/app/data
    ports:
      - ${COVABOT_WEB_PORT:-7080}:7080
      - ${COVABOT_METRICS_PORT:-9303}:3000
    networks:
      - starbunk-net
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    labels:
      - com.starbunk.service=covabot
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
  # BlueBot - Blue detection bot
  bluebot:
    image: ghcr.io/andrewgari/bluebot:prod
    container_name: starbunk-bluebot
    restart: unless-stopped
    env_file:
      - /mnt/user/appdata/dockge/stacks/starbunk-js/.env
    environment:
      - NODE_ENV=production
      - BLUEBOT_TOKEN=${BLUEBOT_TOKEN:-${STARBUNK_TOKEN}}
      - STARBUNK_TOKEN=${STARBUNK_TOKEN}
      - HEALTH_PORT=3000
    volumes:
      - /mnt/user/appdata/dockge/stacks/starbunk-js/config/bluebot:/app/config:ro
    ports:
      - ${BLUEBOT_METRICS_PORT:-9302}:3000
    networks:
      - starbunk-net
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    labels:
      - com.starbunk.service=bluebot
      - prometheus.io/scrape=true
      - prometheus.io/path=/metrics
      - prometheus.io/port=3000
      - com.centurylinklabs.watchtower.enable=true
networks:
  starbunk-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
